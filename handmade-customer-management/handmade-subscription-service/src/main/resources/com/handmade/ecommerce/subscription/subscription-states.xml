<?xml version="1.0" encoding="UTF-8"?>
<!--
Standard E-commerce Subscription State Machine
Purpose: Manage customer subscriptions (e.g. Plus/Prime plans).
Flow: SUBSCRIPTION_FLOW
Lifecycle: CREATED -> TRIAL -> ACTIVE -> GRACE -> EXPIRED / CANCELLED
-->
<states>
    <event-information eventId="startTrial"   eventName="Start trial"   meta-acls="user.normal"/>
    <event-information eventId="activatePaid" eventName="Activate paid" meta-acls="billing.ops"/>
    <event-information eventId="renew"        eventName="Renew"         meta-acls="billing.ops"/>
    <event-information eventId="enterGrace"  eventName="Enter grace"   meta-acls="billing.ops"/>
    <event-information eventId="expire"       eventName="Expire"        meta-acls="billing.ops"/>
    <event-information eventId="cancel"       eventName="Cancel"        meta-acls="user.normal,billing.ops"/>

    <flow id="SUBSCRIPTION_FLOW" default="true">
        <!-- Subscription object exists but not yet started -->
        <manual-state id="CREATED" initialState="true">
            <on eventId="startTrial"   newStateId="TRIAL"  componentName="subscriptionStartTrialAction"/>
            <on eventId="activatePaid" newStateId="ACTIVE" componentName="subscriptionActivatePaidAction"/>
            <on eventId="cancel"        newStateId="CANCELLED" componentName="subscriptionCancelAction"/>
        </manual-state>

        <!-- Trial period -->
        <manual-state id="TRIAL">
            <on eventId="activatePaid" newStateId="ACTIVE" componentName="subscriptionActivatePaidAction"/>
            <on eventId="expire"        newStateId="EXPIRED" componentName="subscriptionExpireAction"/>
            <on eventId="cancel"        newStateId="CANCELLED" componentName="subscriptionCancelAction"/>
        </manual-state>

        <!-- Paid active -->
        <manual-state id="ACTIVE">
            <on eventId="renew"       newStateId="ACTIVE"    componentName="subscriptionRenewAction"/>
            <on eventId="enterGrace" newStateId="GRACE"     componentName="subscriptionEnterGraceAction"/>
            <on eventId="cancel"      newStateId="CANCELLED" componentName="subscriptionCancelAction"/>
        </manual-state>

        <!-- Grace period after failed renewal -->
        <manual-state id="GRACE">
            <on eventId="renew"  newStateId="ACTIVE"  componentName="subscriptionRenewAction"/>
            <on eventId="expire" newStateId="EXPIRED" componentName="subscriptionExpireAction"/>
            <on eventId="cancel" newStateId="CANCELLED" componentName="subscriptionCancelAction"/>
        </manual-state>

        <manual-state id="EXPIRED"   meta-endState="true"/>
        <manual-state id="CANCELLED" meta-endState="true"/>
    </flow>
</states>
