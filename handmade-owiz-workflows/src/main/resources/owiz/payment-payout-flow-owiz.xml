<?xml version="1.0" encoding="UTF-8"?>
<!--
OWIZ Workflows
Description: Payment + payout orchestration that drives PAYMENT_FLOW and Payout STM.
Version: 1.1
-->
<flows>
    <add-command-tag tag="parallel" componentName="org.chenile.owiz.impl.ParallelChain"/>

    <!--
    Flow: PAYMENT_PAYOUT_FLOW
    Trigger: AUTHORIZE_PAYMENT

    Expected STMs:
    - PAYMENT_FLOW: INIT -> AUTH_PENDING -> AUTH_SUCCESS -> CAPTURED / FAILED / VOIDED
    - PAYOUT_FLOW: CREATED -> SCHEDULED -> PROCESSING -> PAID / FAILED / CANCELLED
    -->
    <flow id="PAYMENT_PAYOUT_FLOW" triggerEvent="AUTHORIZE_PAYMENT">
        <!-- Authorize payment (fires authorize_payment on PAYMENT_FLOW) -->
        <command id="authorizePayment" componentName="paymentAuthService" retryLimit="3" retryDelay="1000" timeoutMs="10000" onError="stop"/>

        <!-- Capture payment (fires capture_payment on PAYMENT_FLOW) -->
        <command id="capturePayment" componentName="paymentCaptureService" retryLimit="3" retryDelay="1000" timeoutMs="10000" onError="stop"/>

        <!-- Update order STM based on payment result -->
        <command id="updateOrderState" componentName="orderStateUpdateService" retryLimit="3" retryDelay="1000" timeoutMs="3000" onError="stop"/>

        <!-- Issue invoice / billing side effects -->
        <command id="triggerInvoice" componentName="billingService" retryLimit="3" retryDelay="1000" timeoutMs="5000" onError="stop"/>
    </flow>
</flows>
