<?xml version="1.0" encoding="UTF-8"?>
<!--
Standard E-commerce OrderLine State Machine
Purpose: Track each item line through fulfilment, delivery, and post-delivery actions.
Flow: ORDER_LINE_FLOW
-->
<states>
    <!-- Event definitions (kept lean, cart logic handled elsewhere) -->
    <event-information eventId='reserveStock'/>
    <event-information eventId='releaseStock'/>
    <event-information eventId='packItem'/>
    <event-information eventId='shipItem'/>
    <event-information eventId='deliverItem'/>
    <event-information eventId='cancelItem'/>
    <event-information eventId='requestReturn'/>
    <event-information eventId='completeReturn'/>

    <flow id='ORDER_LINE_FLOW' default='true'>
        <entry-action componentName='orderLineEntryAction'/>
        <exit-action componentName='orderLineExitAction'/>

        <!-- Created when order is placed, stock not yet reserved -->
        <manual-state id="PENDING_RESERVATION" initialState="true">
            <on eventId="reserveStock" newStateId="RESERVED" componentName="orderLineReserveStockAction"/>
            <on eventId="cancelItem" newStateId="CANCELLED" componentName="orderLineCancelAction"/>
        </manual-state>

        <!-- Inventory reserved successfully -->
        <manual-state id="RESERVED">
            <on eventId="packItem" newStateId="PACKED" componentName="orderLinePackAction"/>
            <on eventId="releaseStock" newStateId="CANCELLED" componentName="orderLineReleaseStockAction"/>
        </manual-state>

        <!-- Item packed and ready for shipment -->
        <manual-state id="PACKED">
            <on eventId="shipItem" newStateId="SHIPPED" componentName="orderLineShipAction"/>
        </manual-state>

        <!-- In transit with carrier -->
        <manual-state id="SHIPPED">
            <on eventId="deliverItem" newStateId="DELIVERED" componentName="orderLineDeliverAction"/>
        </manual-state>

        <!-- Delivered to customer -->
        <manual-state id="DELIVERED" meta-endState="true">
            <on eventId="requestReturn" newStateId="RETURN_REQUESTED" componentName="orderLineReturnRequestAction"/>
        </manual-state>

        <!-- Return initiated for this line -->
        <manual-state id="RETURN_REQUESTED">
            <on eventId="completeReturn" newStateId="RETURN_COMPLETED" componentName="orderLineReturnCompleteAction"/>
        </manual-state>

        <manual-state id="RETURN_COMPLETED" meta-endState="true"/>

        <!-- Cancelled at any pre-delivery stage -->
        <manual-state id="CANCELLED" meta-endState="true"/>
    </flow>
</states>
