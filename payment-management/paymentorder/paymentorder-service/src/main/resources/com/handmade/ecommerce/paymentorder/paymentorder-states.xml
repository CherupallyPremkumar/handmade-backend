<?xml version="1.0" encoding="UTF-8"?>
<!--
PaymentOrder State Machine
Tracks individual seller payment lifecycle within a Payment.
Each PaymentOrder represents payment to one seller.

State Flow (Two-Phase):
Phase 1 (Registration - Synchronous):
NOT_STARTED → PENDING_USER_ACTION

Phase 2 (Confirmation - Asynchronous via Webhook):
PENDING_USER_ACTION → EXECUTING → SUCCESS/FAILED

Refund Flow (Optional):
SUCCESS → REFUND_INITIATED → REFUNDED/REFUND_FAILED

States:
- NOT_STARTED: PaymentOrder created but not yet registered with PSP
- PENDING_USER_ACTION: Checkout session created, waiting for user to pay on PSP page
- EXECUTING: User submitted payment, PSP is processing
- SUCCESS: Payment completed successfully, wallet credited, ledger updated
- FAILED: Payment failed (PSP rejected, network error, validation error)
- REFUND_INITIATED: Refund process started
- REFUNDED: Successfully refunded
- REFUND_FAILED: Refund failed
-->
<states>
    <enablement-strategy componentName="paymentOrderConfigBasedEnablementStrategy"/>
    <default-transition-action componentName="paymentOrderBaseTransitionAction"/>
    
    <!-- Define custom DSL tags for payment order workflow -->
    <add-state-tag tag="status" manualState="true"/>
    <add-transition-tag tag="on-action" eventIdTag="id" newStateIdTag="move-to"
                        meta-acls="payment.order.manage"/>
    <add-transition-tag tag="webhook-action" eventIdTag="id" newStateIdTag="move-to"
                        componentNameTag="action" meta-acls="payment.webhook"/>
    
    <!-- Activities for post-success processing -->
    <add-transition-tag tag="post-success-activity" meta-activity="MANDATORY"
                        eventIdTag="id"/>
    <add-state-tag tag="post-success-check"
                   componentName="postSuccessActivitiesCheck"
                   id="ArePostSuccessActivitiesComplete"
                   whichStateId="SUCCESS" />
    <add-transition-tag tag="on-activities-complete" newStateIdTag="goto" eventId="yes"/>
    <add-transition-tag tag="if-activities-incomplete" newStateIdTag="stay-in" eventId="no"/>

    <flow id='PaymentOrderFlow' default='true'>
        <entry-action componentName="paymentOrderEntryAction"/>
        <exit-action componentName="paymentOrderExitAction"/>
        <security-strategy componentName="stmSecurityStrategy"/>
        
        <!-- NOT_STARTED: Initial state when PaymentOrder is created -->
        <status id='NOT_STARTED' initialState='true'>
            <!-- Orchestrator calls this to register with PSP -->
            <on-action id='registerWithPSP' move-to='PENDING_USER_ACTION'/>
            
            <!-- Can fail during registration -->
            <on-action id='registrationFailed' move-to='FAILED'/>
        </status>

        <!-- PENDING_USER_ACTION: Checkout session created, waiting for user -->
        <status id='PENDING_USER_ACTION'>
            <!-- User completes payment on PSP page (webhook triggered) -->
            <webhook-action id='paymentSubmitted' move-to='EXECUTING' 
                          action='handlePaymentSubmitted'/>
            
            <!-- User abandons payment or session expires -->
            <webhook-action id='paymentAbandoned' move-to='FAILED' 
                          action='handlePaymentAbandoned'/>
            
            <!-- Timeout after certain period -->
            <on-action id='timeout' move-to='FAILED'/>
        </status>

        <!-- EXECUTING: PSP is processing the payment -->
        <status id='EXECUTING'>
            <!-- PSP confirms payment success (webhook) -->
            <webhook-action id='paymentCaptured' move-to='SUCCESS' 
                          action='handlePaymentCaptured'/>
            
            <!-- PSP reports payment failure (webhook) -->
            <webhook-action id='paymentFailed' move-to='FAILED' 
                          action='handlePaymentFailed'/>
            
            <!-- Timeout if PSP doesn't respond -->
            <on-action id='executionTimeout' move-to='FAILED'/>
        </status>

        <!-- SUCCESS: Payment completed successfully -->
        <status id='SUCCESS'>
            <!-- Post-success mandatory activities -->
            <post-success-activity id='creditWallet'/>
            <post-success-activity id='createLedgerEntry'/>
            <post-success-activity id='notifySeller'/>
            
            <!-- Check if all post-success activities are complete -->
            <post-success-check>
                <on-activities-complete goto="SUCCESS"/>
                <if-activities-incomplete stay-in="SUCCESS"/>
            </post-success-check>
            
            <!-- Mark as ready for distribution (called by webhook) -->
            <on-action id='mark_ready' move-to='READY_FOR_DISTRIBUTION'/>
            
            <!-- Initiate refund if needed -->
            <on-action id='initiateRefund' move-to='REFUND_INITIATED'/>
        </status>

        <!-- READY_FOR_DISTRIBUTION: Payment captured, ready for seller payout -->
        <status id='READY_FOR_DISTRIBUTION'>
            <!-- After 7-day hold, mark as available for payout -->
            <on-action id='mark_available' move-to='AVAILABLE_FOR_PAYOUT'/>
            
            <!-- Refund can still happen during hold period -->
            <on-action id='initiateRefund' move-to='REFUND_INITIATED'/>
        </status>

        <!-- AVAILABLE_FOR_PAYOUT: Hold period passed, seller can withdraw -->
        <status id='AVAILABLE_FOR_PAYOUT'>
            <!-- Process payout to seller -->
            <on-action id='processPayout' move-to='PAYOUT_INITIATED'/>
            
            <!-- Refund can still happen -->
            <on-action id='initiateRefund' move-to='REFUND_INITIATED'/>
        </status>

        <!-- PAYOUT_INITIATED: Payout in progress -->
        <status id='PAYOUT_INITIATED'>
            <!-- Payout successful -->
            <on-action id='payoutCompleted' move-to='PAYOUT_COMPLETED'/>
            
            <!-- Payout failed -->
            <on-action id='payoutFailed' move-to='PAYOUT_FAILED'/>
        </status>

        <!-- PAYOUT_COMPLETED: Money transferred to seller -->
        <status id='PAYOUT_COMPLETED'>
            <!-- Terminal state - payout complete -->
        </status>

        <!-- PAYOUT_FAILED: Payout failed -->
        <status id='PAYOUT_FAILED'>
            <!-- Retry payout -->
            <on-action id='retryPayout' move-to='PAYOUT_INITIATED'/>
            
            <!-- Return to available for manual intervention -->
            <on-action id='returnToAvailable' move-to='AVAILABLE_FOR_PAYOUT'/>
        </status>

        <!-- FAILED: Payment failed -->
        <status id='FAILED'>
            <!-- Can retry the payment order -->
            <on-action id='retry' move-to='NOT_STARTED'/>
            
            <!-- Or mark as permanently failed -->
            <on-action id='markPermanentFailure' move-to='FAILED'/>
        </status>

        <!-- REFUND_INITIATED: Refund process started -->
        <status id='REFUND_INITIATED'>
            <!-- PSP confirms refund success -->
            <webhook-action id='refundCaptured' move-to='REFUNDED' 
                          action='handleRefundCaptured'/>
            
            <!-- PSP reports refund failure -->
            <webhook-action id='refundFailed' move-to='REFUND_FAILED' 
                          action='handleRefundFailed'/>
        </status>

        <!-- REFUNDED: Successfully refunded -->
        <status id='REFUNDED'>
            <!-- Post-refund activities -->
            <on-action id='debitWallet' move-to='REFUNDED'/>
            <on-action id='reverseLedgerEntry' move-to='REFUNDED'/>
            <on-action id='notifySellerRefund' move-to='REFUNDED'/>
        </status>

        <!-- REFUND_FAILED: Refund failed -->
        <status id='REFUND_FAILED'>
            <!-- Retry refund -->
            <on-action id='retryRefund' move-to='REFUND_INITIATED'/>
            
            <!-- Manual intervention required -->
            <on-action id='escalateToManual' move-to='REFUND_FAILED'/>
        </status>

    </flow>
    
</states>
