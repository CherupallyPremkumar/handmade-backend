<?xml version="1.0" encoding="UTF-8"?>
<!--
Standard E-commerce SellerOnboardingCase State Machine (Flipkart-style)
Purpose: Manage seller onboarding from application to go-live, including KYC, policy, and finance steps.
Flow: SELLER_ONBOARDING_FLOW
Lifecycle (high level):
APPLIED -> KYC_IN_PROGRESS -> POLICY_EVALUATION -> FINANCE_SETUP -> READY_FOR_GO_LIVE -> COMPLETED / REJECTED
-->
<states>
    <!-- Core onboarding events -->
    <event-information eventId='submit-application'
                       eventName='Submit onboarding application'
                       meta-acls="seller.self"
                       meta-bodyType='com.handmade.ecommerce.seller.onboarding.dto.StartOnboardingPayload'/>

    <event-information eventId='kyc-started'
                       eventName='Start KYC review'
                       meta-acls="kyc.ops"
                       meta-bodyType='com.handmade.ecommerce.seller.onboarding.dto.KycStartedPayload'/>

    <event-information eventId='kyc-approved'
                       eventName='KYC approved'
                       meta-acls="kyc.ops"
                       meta-bodyType='com.handmade.ecommerce.seller.onboarding.dto.IdentityVerifiedPayload'/>

    <event-information eventId='kyc-rejected'
                       eventName='KYC rejected'
                       meta-acls="kyc.ops"
                       meta-bodyType='com.handmade.ecommerce.seller.onboarding.dto.RejectOnboardingPayload'/>

    <event-information eventId='submit-docs'
                       eventName='Submit additional documents'
                       meta-acls="seller.self"
                       meta-bodyType='com.handmade.ecommerce.seller.onboarding.dto.SubmitDocsPayload'/>

    <!-- Policy evaluation events -->
    <event-information eventId='start-policy-eval'
                       eventName='Start policy evaluation'
                       meta-acls="policy.governance"
                       meta-bodyType='com.handmade.ecommerce.seller.onboarding.dto.StartPolicyEvaluationPayload'/>

    <event-information eventId='policy-approved'
                       eventName='Policy approved'
                       meta-acls="policy.governance"
                       meta-bodyType='com.handmade.ecommerce.seller.onboarding.dto.PolicyApprovedPayload'/>

    <event-information eventId='policy-flagged'
                       eventName='Policy flagged for manual review'
                       meta-acls="policy.governance"
                       meta-bodyType='com.handmade.ecommerce.seller.onboarding.dto.PolicyFlaggedPayload'/>

    <event-information eventId='manual-approve'
                       eventName='Manual approve after review'
                       meta-acls="policy.governance"
                       meta-bodyType='com.handmade.ecommerce.seller.onboarding.dto.ManualApprovePayload'/>

    <!-- Finance & go-live events -->
    <event-information eventId='finance-profile-created'
                       eventName='Finance profile created'
                       meta-acls="finance.ops"
                       meta-bodyType='com.handmade.ecommerce.seller.onboarding.dto.FinanceProfileCreatedPayload'/>

    <event-information eventId='go-live-confirmed'
                       eventName='Confirm onboarding and go live'
                       meta-acls="seller.ops"
                       meta-bodyType='com.handmade.ecommerce.seller.onboarding.dto.ConfirmOnboardingPayload'/>

    <!-- Rejection / cancellation -->
    <event-information eventId='reject'
                       eventName='Reject onboarding'
                       meta-acls="seller.ops,kyc.ops,policy.governance"
                       meta-bodyType='com.handmade.ecommerce.seller.onboarding.dto.RejectOnboardingPayload'/>

    <flow id="SELLER_ONBOARDING_FLOW" default="true">
        <!-- Seller has applied but no checks have started yet -->
        <manual-state id="APPLIED" initialState="true">
            <on eventId="kycStarted" newStateId="KYC_IN_PROGRESS" componentName="startOnboardingAction"/>
            <on eventId="reject"      newStateId="REJECTED"        componentName="rejectOnboardingAction"/>
        </manual-state>

        <!-- KYC documents and identity verification in progress -->
        <manual-state id="KYC_IN_PROGRESS">
            <on eventId="submitDocs"  newStateId="KYC_IN_PROGRESS"  componentName="submitDocsAction"/>
            <on eventId="kycApproved" newStateId="POLICY_EVALUATION_PENDING" componentName="identityVerifiedAction"/>
            <on eventId="kycRejected" newStateId="REJECTED"        componentName="rejectOnboardingAction"/>
        </manual-state>

        <!-- Waiting for automated policy engine evaluation -->
        <manual-state id="POLICY_EVALUATION_PENDING">
            <on eventId="startPolicyEval" newStateId="POLICY_EVALUATION" componentName="policyEvaluationAction"/>
        </manual-state>

        <!-- Automated policy evaluation running -->
        <manual-state id="POLICY_EVALUATION">
            <on eventId="policyApproved" newStateId="FINANCE_SETUP"   componentName="policyApprovedAction"/>
            <on eventId="policyFlagged"  newStateId="POLICY_MANUAL_REVIEW" componentName="policyFlaggedAction"/>
            <on eventId="reject"          newStateId="REJECTED"        componentName="rejectOnboardingAction"/>
        </manual-state>

        <!-- Manual review by governance team when flags are raised -->
        <manual-state id="POLICY_MANUAL_REVIEW">
            <on eventId="manualApprove" newStateId="FINANCE_SETUP" componentName="manualApproveAction"/>
            <on eventId="reject"         newStateId="REJECTED"      componentName="rejectOnboardingAction"/>
        </manual-state>

        <!-- Finance/payout configuration (bank, tax, payout policy) -->
        <manual-state id="FINANCE_SETUP">
            <on eventId="financeProfileCreated" newStateId="READY_FOR_GO_LIVE" componentName="financeReadyAction"/>
        </manual-state>

        <!-- All checks passed; waiting for ops to press go-live -->
        <manual-state id="READY_FOR_GO_LIVE">
            <on eventId="goLiveConfirmed" newStateId="COMPLETED" componentName="confirmOnboardingAction"/>
        </manual-state>

        <!-- Final states -->
        <manual-state id="COMPLETED" meta-endState="true"/>
        <manual-state id="REJECTED"  meta-endState="true"/>
    </flow>
</states>
