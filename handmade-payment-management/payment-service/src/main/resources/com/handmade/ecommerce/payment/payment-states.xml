<?xml version="1.0" encoding="UTF-8"?>
<!--
Payment State Machine
Purpose: Tracks the overall payment lifecycle for a checkout transaction
Lifecycle: CREATED → PROCESSING → PARTIALLY_COMPLETED/COMPLETED/FAILED → REFUND_INITIATED → REFUNDED/REFUND_FAILED

A Payment can contain multiple PaymentOrders (one per seller).
This state machine orchestrates the overall payment status based on individual PaymentOrder statuses.

States:
- CREATED: Payment record created, PaymentOrders being registered
- PROCESSING: All PaymentOrders registered, waiting for user payment actions
- PARTIALLY_COMPLETED: Some PaymentOrders succeeded, others pending/failed
- COMPLETED: All PaymentOrders successfully processed
- FAILED: All PaymentOrders failed
- CANCELLED: Payment cancelled by user or system
- REFUND_INITIATED: Refund process started
- REFUNDED: Successfully refunded (terminal state)
- REFUND_FAILED: Refund processing failed

Events:
- startProcessing: Begin processing payment
- cancel: Cancel payment
- checkCompletion: Auto-check if all orders successful
- checkPartialCompletion: Auto-check if some orders successful
- checkFailure: Auto-check if all orders failed
- retryFailed: Retry failed payment orders
- completePartial: Mark as completed with partial success
- checkFullCompletion: Auto-check for full completion after retry
- initiateRefund: Start refund process
- retry: Retry entire payment
- refundComplete: Auto-transition when refunds processed
- refundFailed: Auto-transition when refund fails
- retryRefund: Retry failed refund

Custom DSL Tags:
- status: Equivalent to manual-state
- on-action: Manual event transition
- auto-transition: Automatic transition based on condition
-->
<states>
	<!-- Enablement and security strategies -->
	<enablement-strategy componentName="paymentConfigBasedEnablementStrategy"/>
	<default-transition-action componentName="paymentBaseTransitionAction"/>
	
	<!-- Define custom DSL tags for payment workflow -->
	<add-state-tag tag="status" manualState="true"/>
	<add-transition-tag tag="on-action" 
	                    eventIdTag="id" 
	                    newStateIdTag="move-to"
	                    meta-acls="payment.manage"/>
	<add-transition-tag tag="auto-transition" 
	                    eventIdTag="id" 
	                    newStateIdTag="move-to"
	                    componentNameTag="action"/>

	<flow id='PAYMENT_FLOW' default='true'>
		
		<!-- Lifecycle hooks -->
		<entry-action componentName="paymentEntryAction"/>
		<exit-action componentName="paymentExitAction"/>
		<security-strategy componentName="stmSecurityStrategy"/>
		
		<!-- CREATED: Initial state when payment is created -->
		<status id='CREATED' initialState='true'>
			<on-action id='startProcessing' move-to='PROCESSING'/>
			<on-action id='cancel' move-to='CANCELLED'/>
		</status>

		<!-- PROCESSING: PaymentOrders registered, waiting for user to complete payments -->
		<status id='PROCESSING'>
			<!-- Automatic transitions based on PaymentOrder statuses -->
			<auto-transition id='checkCompletion' 
			                 move-to='COMPLETED' 
			                 action='allOrdersSuccessful'/>
			<auto-transition id='checkPartialCompletion' 
			                 move-to='PARTIALLY_COMPLETED' 
			                 action='someOrdersSuccessful'/>
			<auto-transition id='checkFailure' 
			                 move-to='FAILED' 
			                 action='allOrdersFailed'/>
			
			<!-- Manual actions -->
			<on-action id='cancel' move-to='CANCELLED'/>
		</status>

		<!-- PARTIALLY_COMPLETED: Some orders succeeded, others failed/pending -->
		<status id='PARTIALLY_COMPLETED'>
			<!-- Can retry failed orders -->
			<on-action id='retryFailed' move-to='PROCESSING'/>
			
			<!-- Or mark as completed with partial success -->
			<on-action id='completePartial' move-to='COMPLETED'/>
			
			<!-- Auto-transition if all remaining orders complete -->
			<auto-transition id='checkFullCompletion' 
			                 move-to='COMPLETED' 
			                 action='allOrdersSuccessful'/>
		</status>

		<!-- COMPLETED: All PaymentOrders successfully processed -->
		<status id='COMPLETED'>
			<!-- Can initiate refund -->
			<on-action id='initiateRefund' move-to='REFUND_INITIATED'/>
		</status>

		<!-- FAILED: All PaymentOrders failed -->
		<status id='FAILED'>
			<!-- Can retry the entire payment -->
			<on-action id='retry' move-to='PROCESSING'/>
			
			<!-- Or cancel permanently -->
			<on-action id='cancel' move-to='CANCELLED'/>
		</status>

		<!-- CANCELLED: Payment cancelled (terminal state) -->
		<status id='CANCELLED' meta-endState="true"/>

		<!-- REFUND_INITIATED: Refund process started -->
		<status id='REFUND_INITIATED'>
			<auto-transition id='refundComplete' 
			                 move-to='REFUNDED' 
			                 action='allRefundsProcessed'/>
			<auto-transition id='refundFailed' 
			                 move-to='REFUND_FAILED' 
			                 action='refundProcessingFailed'/>
		</status>

		<!-- REFUNDED: Successfully refunded (terminal state) -->
		<status id='REFUNDED' meta-endState="true"/>

		<!-- REFUND_FAILED: Refund failed -->
		<status id='REFUND_FAILED'>
			<on-action id='retryRefund' move-to='REFUND_INITIATED'/>
		</status>

	</flow>
	
</states>
