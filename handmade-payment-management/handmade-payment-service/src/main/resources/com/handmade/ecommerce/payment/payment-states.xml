<?xml version="1.0" encoding="UTF-8"?>
<!--
Standard E-commerce PaymentTransaction State Machine
Purpose: Manage auth, capture, and failure/refund paths for payments.
Flow: PAYMENT_FLOW
-->
<states>
    <event-information eventId='initPayment'
                       eventName='Init payment'
                       meta-acls="user.normal,user.admin"/>
    <event-information eventId='authorizePayment'
                       eventName='Authorize payment'
                       meta-acls="user.normal,user.admin"/>
    <event-information eventId='capturePayment'
                       eventName='Capture payment'
                       meta-acls="user.normal,user.admin"/>
    <event-information eventId='failPayment'
                       eventName='Fail payment'
                       meta-acls="user.normal,user.admin"/>
    <event-information eventId='voidPayment'
                       eventName='Void payment'
                       meta-acls="user.normal,user.admin"/>

    <flow id="PAYMENT_FLOW" default="true">
        <!-- Payment intent created, not yet sent to PSP -->
        <manual-state id="INIT" initialState="true">
            <on eventId="authorizePayment" newStateId="AUTH_PENDING" componentName="paymentAuthAction"/>
            <on eventId="failPayment" newStateId="FAILED" componentName="paymentFailAction"/>
        </manual-state>

        <!-- PSP auth in progress or awaiting callback -->
        <manual-state id="AUTH_PENDING">
            <on eventId="authorizePayment" newStateId="AUTH_SUCCESS" componentName="paymentAuthAction"/>
            <on eventId="failPayment" newStateId="FAILED" componentName="paymentFailAction"/>
            <on eventId="voidPayment" newStateId="VOIDED" componentName="paymentVoidAction"/>
        </manual-state>

        <!-- Authorization complete, capture still pending -->
        <manual-state id="AUTH_SUCCESS">
            <on eventId="capturePayment" newStateId="CAPTURED" componentName="paymentCaptureAction"/>
            <on eventId="voidPayment" newStateId="VOIDED" componentName="paymentVoidAction"/>
        </manual-state>

        <!-- Funds captured; refunds handled by Refund STM -->
        <manual-state id="CAPTURED" meta-endState="true"/>

        <!-- Failed or voided -->
        <manual-state id="FAILED" meta-endState="true"/>
        <manual-state id="VOIDED" meta-endState="true"/>
    </flow>
</states>
