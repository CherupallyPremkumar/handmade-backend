<?xml version="1.0" encoding="UTF-8"?>
<!--
Product State Machine
Purpose: Manages the lifecycle of product entities from creation to archival
Lifecycle: DRAFT → IN_REVIEW → READY_FOR_PUBLISH → ACTIVE → HIDDEN → ARCHIVED

States:
- DRAFT: Product created but not yet submitted for review
- IN_REVIEW: Product submitted and under review by admin
- READY_FOR_PUBLISH: Product approved and ready to be published
- ACTIVE: Product published and visible to customers
- HIDDEN: Product temporarily hidden from customers
- ARCHIVED: Product permanently archived (terminal state)

Events:
- submit: Submit product for review
- approve: Approve product after review
- request_changes: Request changes to product
- publish: Publish approved product
- hide: Hide active product from customers
- unhide: Make hidden product visible again
- archive: Permanently archive product
-->
<states>

	<!-- Event metadata for API documentation -->
	<event-information eventId='submit' 
	                   eventName='submit product' 
	                   meta-acls="test.normal,test.premium"
	                   meta-bodyType="com.handmade.ecommerce.product.dto.OnSubmitProductPayload"/>
	<event-information eventId='approve' 
	                   eventName='approve product' 
	                   meta-acls="test.normal,test.premium"
	                   meta-bodyType="com.handmade.ecommerce.product.dto.OnSubmitProductPayload"/>
	<event-information eventId='publish' 
	                   eventName='publish product' 
	                   meta-acls="test.normal,test.premium"
	                   meta-bodyType="com.handmade.ecommerce.product.dto.OnSubmitProductPayload"/>

	<flow id="PRODUCT_FLOW" default="true">

		<!-- Lifecycle hooks -->
		<entry-action componentName="productEntryAction"/>
		<exit-action componentName="productExitAction"/>

		<!-- DRAFT: Initial product creation -->
		<manual-state id="DRAFT" initialState="true">
			<on eventId="submit" 
			    newStateId="IN_REVIEW" 
			    componentName="onSubmitProductService"/>
		</manual-state>

		<!-- IN_REVIEW: Product under review -->
		<manual-state id="IN_REVIEW">
			<on eventId="approve" 
			    newStateId="READY_FOR_PUBLISH" 
			    componentName="onApproveProductService"/>
			<on eventId="request_changes" 
			    newStateId="DRAFT" 
			    componentName="onRequestChangesProductService"/>
		</manual-state>

		<!-- READY_FOR_PUBLISH: Approved, awaiting publication -->
		<manual-state id="READY_FOR_PUBLISH">
			<on eventId="publish" 
			    newStateId="ACTIVE" 
			    componentName="onPublishProductService"/>
			<on eventId="request_changes" 
			    newStateId="IN_REVIEW" 
			    componentName="onRequestChangesProductService"/>
		</manual-state>

		<!-- ACTIVE: Product live and visible -->
		<manual-state id="ACTIVE">
			<on eventId="hide" 
			    newStateId="HIDDEN" 
			    componentName="onHideProductService"/>
		</manual-state>

		<!-- HIDDEN: Product temporarily hidden -->
		<manual-state id="HIDDEN">
			<on eventId="archive" 
			    newStateId="ARCHIVED" 
			    componentName="onArchiveProductService"/>
			<on eventId="unhide" 
			    newStateId="ACTIVE" 
			    componentName="onUnhideProductService"/>
		</manual-state>

		<!-- ARCHIVED: Terminal state -->
		<manual-state id="ARCHIVED" meta-endState="true"/>

	</flow>

</states>