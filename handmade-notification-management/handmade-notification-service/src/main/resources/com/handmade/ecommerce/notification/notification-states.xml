<?xml version="1.0" encoding="UTF-8"?>
<!--
Notification Delivery State Machine
Purpose: Manage lifecycle of notification delivery from queue to delivered/failed.
Flow: NOTIFICATION_DELIVERY_FLOW
Lifecycle: QUEUED -> PROCESSING -> SENT -> DELIVERED/FAILED
-->
<states>
    <!-- Notification Delivery Events -->
    <event-information eventId="queueNotification"  eventName="Queue notification"  meta-acls="system"/>
    <event-information eventId="startProcessing"    eventName="Start processing"    meta-acls="system"/>
    <event-information eventId="sendNotification"   eventName="Send notification"   meta-acls="system"/>
    <event-information eventId="markDelivered"      eventName="Mark delivered"      meta-acls="system"/>
    <event-information eventId="markFailed"         eventName="Mark failed"         meta-acls="system"/>
    <event-information eventId="retryNotification"  eventName="Retry notification"  meta-acls="system"/>

    <!--
    Flow: NOTIFICATION_DELIVERY_FLOW
    Lifecycle: QUEUED -> PROCESSING -> SENT -> DELIVERED/FAILED
    -->
    <flow id="NOTIFICATION_DELIVERY_FLOW" default="true">
        <auto-state id="QUEUED" initialState="true">
            <on eventId="startProcessing"    newStateId="PROCESSING"  componentName="notificationStartProcessingAction"/>
        </auto-state>

        <auto-state id="PROCESSING">
            <on eventId="sendNotification"   newStateId="SENT"        componentName="notificationSendAction"/>
            <on eventId="markFailed"         newStateId="FAILED"      componentName="notificationFailAction"/>
        </auto-state>

        <auto-state id="SENT">
            <on eventId="markDelivered"      newStateId="DELIVERED"   componentName="notificationDeliverAction"/>
            <on eventId="markFailed"         newStateId="FAILED"      componentName="notificationFailAction"/>
        </auto-state>

        <manual-state id="FAILED">
            <on eventId="retryNotification"  newStateId="QUEUED"      componentName="notificationRetryAction"/>
        </manual-state>

        <manual-state id="DELIVERED" meta-endState="true"/>
    </flow>
</states>