<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="admin-marketplace-health">

    <!-- Overall Marketplace Stats -->
    <select id="admin-marketplace-stats" resultType="map">
        SELECT 
            'SELLERS' as "metric_type",
            'ALL' as "metric_group",
            COUNT(*) as "metric_count"
        FROM hm_seller_account
        WHERE tenant = #{tenantId} AND deleted = false
        
        UNION
        
        SELECT 
            'SELLERS' as "metric_type",
            'PENDING_KYC' as "metric_group",
            COUNT(*) as "metric_count"
        FROM hm_seller_kyc
        WHERE tenant = #{tenantId} AND state_id = 'PENDING'
        
        UNION
        
        SELECT 
            'PRODUCTS' as "metric_type",
            'ALL' as "metric_group",
            COUNT(*) as "metric_count"
        FROM hm_product
        WHERE tenant = #{tenantId}
        
        UNION
        
        SELECT 
            'DISPUTES' as "metric_type",
            'ACTIVE' as "metric_group",
            COUNT(*) as "metric_count"
        FROM hm_dispute
        WHERE tenant = #{tenantId} AND state_id != 'RESOLVED' AND state_id != 'CLOSED'
        
        UNION
        
        SELECT 
            'LOCALES' as "metric_type",
            'ALL' as "metric_group",
            COUNT(*) as "metric_count"
        FROM hm_region
        WHERE tenant = #{tenantId}
        
        UNION
        
        SELECT 
            'ORDERS' as "metric_type",
            state_id as "metric_group",
            COUNT(*) as "metric_count"
        FROM hm_order
        WHERE tenant = #{tenantId} AND created_time >= CURRENT_TIMESTAMP - INTERVAL '30' DAY
        GROUP BY state_id
    </select>

    <!-- Category Health: Product Distribution -->
    <select id="admin-category-health" resultType="java.util.HashMap">
        SELECT 
            bn.id as "node_id",
            bn.name as "node_name",
            COUNT(pbn.product_id) as "product_count"
        FROM hm_browse_node bn
        LEFT JOIN hm_product_browse_node pbn ON pbn.browse_node_id = bn.id
        GROUP BY bn.id, bn.name
        ORDER BY product_count ASC
    </select>

    <!-- Count queries for Chenile framework -->
    <select id="admin-marketplace-stats-count" resultType="int">
        SELECT 100
    </select>

    <select id="admin-category-health-count" resultType="int">
        SELECT COUNT(*)
        FROM hm_browse_node
    </select>

    <select id="admin-system-health" resultType="java.util.HashMap">
        SELECT 
            'DATABASE' as "service",
            'HEALTHY' as "status"
        UNION
        SELECT 
            'CACHE' as "service",
            'HEALTHY' as "status"
        UNION
        SELECT 
            'API_GATEWAY' as "service",
            'HEALTHY' as "status"
    </select>

    <select id="admin-system-health-count" resultType="int">
        SELECT 3
    </select>

    <!-- Revenue Analytics -->
    <select id="admin-revenue-by-platform" resultType="java.util.HashMap">
        SELECT 
            platform_id as "platformId",
            SUM(total) as "revenue",
            COUNT(*) as "orderCount"
        FROM hm_order
        WHERE tenant = #{tenantId} AND state_id != 'CANCELLED'
        GROUP BY platform_id
    </select>

    <select id="admin-revenue-trends" resultType="java.util.HashMap">
        SELECT 
            TO_CHAR(created_time, 'Mon') as "month",
            platform_id as "platformId",
            SUM(total) as "revenue"
        FROM hm_order
        WHERE tenant = #{tenantId} AND state_id != 'CANCELLED'
        AND created_time >= DATE_TRUNC('year', CURRENT_DATE)
        GROUP BY month, platform_id, DATE_TRUNC('month', created_time)
        ORDER BY DATE_TRUNC('month', created_time)
    </select>

</mapper>
