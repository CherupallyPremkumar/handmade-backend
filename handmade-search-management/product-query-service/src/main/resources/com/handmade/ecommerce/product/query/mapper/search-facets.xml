<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="search-facets">
    
    <!-- Aggregate Brand Counts -->
    <select id="brand-facets" resultType="java.util.HashMap">
        SELECT 
            p.brand as "facet_value",
            COUNT(DISTINCT p.id) as "facet_count"
        FROM hm_product p
        JOIN hm_offer o ON o.product_id = p.id
        JOIN hm_price_history ph ON ph.offer_id = o.id
        WHERE p.tenant = #{tenantId}
          AND ph.effective_to IS NULL
        <if test="classification_id != null">
            AND p.classification_id = #{classification_id}
        </if>
        GROUP BY p.brand
        ORDER BY COUNT(DISTINCT p.id) DESC, p.brand DESC
    </select>

    <!-- Aggregate Price Range Counts (Flipkart style buckets) -->
    <select id="price-facets" resultType="java.util.HashMap">
        SELECT 
            CASE 
                WHEN ph.price &lt; 500 THEN 'Under 500'
                WHEN ph.price BETWEEN 500 AND 1000 THEN '500-1000'
                WHEN ph.price BETWEEN 1000 AND 5000 THEN '1000-5000'
                ELSE 'Over 5000'
            END as "facet_value",
            COUNT(DISTINCT p.id) as "facet_count"
        FROM hm_product p
        JOIN hm_offer o ON o.product_id = p.id
        JOIN hm_price_history ph ON ph.offer_id = o.id
        WHERE p.tenant = #{tenantId}
          AND ph.effective_to IS NULL
        <if test="classification_id != null">
            AND p.classification_id = #{classification_id}
        </if>
        <if test="brand != null">
            AND p.brand IN 
            <foreach item="item" index="index" collection="brand" open="(" separator="," close=")">
                #{item}
            </foreach>
        </if>
        GROUP BY 
            CASE 
                WHEN ph.price &lt; 500 THEN 'Under 500'
                WHEN ph.price BETWEEN 500 AND 1000 THEN '500-1000'
                WHEN ph.price BETWEEN 1000 AND 5000 THEN '1000-5000'
                ELSE 'Over 5000'
            END
        ORDER BY COUNT(DISTINCT p.id) DESC
    </select>

    <!-- Aggregate Rating Counts -->
    <select id="rating-facets" resultType="java.util.HashMap">
        SELECT 
            CASE 
                WHEN ra.average_rating >= 4 THEN '4★ &amp; above'
                WHEN ra.average_rating >= 3 THEN '3★ &amp; above'
                WHEN ra.average_rating >= 2 THEN '2★ &amp; above'
                ELSE '1★ &amp; above'
            END as "facet_value",
            COUNT(DISTINCT p.id) as "facet_count"
        FROM hm_product p
        JOIN hm_offer o ON o.product_id = p.id
        JOIN hm_price_history ph ON ph.offer_id = o.id
        LEFT JOIN hm_review_aggregation_snapshot ra ON ra.product_id = p.id
        WHERE p.tenant = #{tenantId}
          AND ph.effective_to IS NULL
        <if test="classification_id != null">
            AND p.classification_id = #{classification_id}
        </if>
        GROUP BY 
            CASE 
                WHEN ra.average_rating >= 4 THEN '4★ &amp; above'
                WHEN ra.average_rating >= 3 THEN '3★ &amp; above'
                WHEN ra.average_rating >= 2 THEN '2★ &amp; above'
                ELSE '1★ &amp; above'
            END
        ORDER BY "facet_value" DESC
    </select>

</mapper>
