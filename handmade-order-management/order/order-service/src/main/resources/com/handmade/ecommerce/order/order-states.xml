<?xml version="1.0" encoding="UTF-8"?>
<states>
    <!-- ======= EVENT DEFINITIONS ======= -->
    <event-information eventId='lineStatusUpdated' meta-bodyType='com.marketplace.order.payload.OrderLineStatusPayload'/>
    <event-information eventId='checkout' meta-bodyType='com.marketplace.order.payload.CheckoutPayload'/>
    <event-information eventId='cancelOrder' meta-bodyType='com.marketplace.order.payload.CancelOrderPayload'/>
    <event-information eventId='paymentConfirmed' meta-bodyType='com.marketplace.order.payload.PaymentConfirmedPayload'/>
    <event-information eventId='paymentFailed' meta-bodyType='com.marketplace.order.payload.PaymentFailedPayload'/>
    <event-information eventId='allLinesReadyToDispatch'/>
    <event-information eventId='anyLineCancelled'/>
    <event-information eventId='dispatch'/>
    <event-information eventId='anyLineNonDispatch'/>
    <event-information eventId='allLinesReadyToShip'/>
    <event-information eventId='anyLineNonshipped'/>
    <event-information eventId='partiallyShipped'/>
    <event-information eventId='allLinesShipped'/>
    <event-information eventId='someLinesDelivered'/>
    <event-information eventId='allLinesDelivered'/>
    <event-information eventId='partiallyDelivered'/>



    <!-- ======= FLOW DEFINITION ======= -->
    <flow id='order-flow' default='true'>
        <entry-action componentName='orderEntryAction'/>
        <exit-action componentName='orderExitAction'/>

        <!-- CART: order is being created -->
        <manual-state id='CART' initialState='true'>
            <on eventId='checkout' componentName='checkoutActionService' newStateId='PAYMENT_PENDING'/>
            <flow id="create-order-flow" defaultFlow="true">
                <chain>
                    <component componentName='validatePaymentCommand'/>
                    <component componentName='createSalesOrderCommand'/>
                    <component componentName='auditCommand'/>
                    <component componentName='publishOrderCreatedEventCommand'/>
                </chain>
            </flow>
            <on eventId='cancelOrder' componentName='cancelOrderAction' newStateId='CANCELLED'/>
        </manual-state>

        <!-- Payment pending -->
        <manual-state id='PAYMENT_PENDING'>
            <on eventId='paymentConfirmed' componentName='paymentConfirmedAction' newStateId='PENDING_SELLER_PREPARATION'/>
            <on eventId='paymentFailed' componentName='paymentFailedAction' newStateId='CART'/>
            <on eventId='cancelOrder' componentName='cancelOrderAct ion' newStateId='CANCELLED'/>
        </manual-state>

        <!-- Aggregate lines preparing by sellers -->
        <manual-state id='PENDING_SELLER_PREPARATION' componentName='aggregateLineStatesAction'>
            <on eventId='allLinesReadyToDispatch' newStateId='CHECK_READY_TO_DISPATCH'/>
            <on eventId='anyLineCancelled' newStateId='CANCELLED'/>
        </manual-state>

        <!-- Ready to dispatch check -->
        <auto-state id='CHECK_READY_TO_DISPATCH' componentName='aggregateLineStatesAction'>
            <on eventId='dispatch' newStateId='READY_TO_DISPATCH'/>
            <on eventId='anyLineNonDispatch' newStateId='PENDING_SELLER_PREPARATION'/>
        </auto-state>

        <!-- Ready to dispatch -->
        <manual-state id='READY_TO_DISPATCH' componentName='aggregateLineStatesAction'>
            <on eventId='allLinesReadyToShip' newStateId='CHECK_PARTIALLY_SHIPPED'/>
            <on eventId='anyLineCancelled' newStateId='CANCELLED'/>
        </manual-state>

        <!-- Partial shipment check -->
        <auto-state id='CHECK_PARTIALLY_SHIPPED' componentName='aggregateLineStatesAction'>
            <on eventId='partiallyShipped' newStateId='PARTIALLY_SHIPPED'/>
            <on eventId='anyLineNonshipped' newStateId='READY_TO_DISPATCH'/>
        </auto-state>

        <!-- Partial shipments -->
        <manual-state id='PARTIALLY_SHIPPED' componentName='aggregateLineStatesAction'>
            <on eventId='allLinesShipped' newStateId='CHECK_DELIVERY_STATUS'/>
            <on eventId='anyLineCancelled' newStateId='CANCELLED'/>
        </manual-state>

        <!-- Shipped -->
        <manual-state id='SHIPPED' componentName='aggregateLineStatesAction'>
            <on eventId='someLinesDelivered' newStateId='CHECK_PARTIAL_DELIVERY'/>
            <on eventId='allLinesDelivered' newStateId='DELIVERED'/>
            <on eventId='anyLineCancelled' newStateId='CANCELLED'/>
        </manual-state>

        <!-- Partial delivery check -->
        <auto-state id='CHECK_PARTIAL_DELIVERY' componentName='aggregateLineStatesAction'>
            <on eventId='partiallyDelivered' newStateId='PARTIALLY_DELIVERED'/>
            <on eventId='allLinesDelivered' newStateId='DELIVERED'/>
        </auto-state>

        <!-- Partial deliveries -->
        <manual-state id='PARTIALLY_DELIVERED' componentName='aggregateLineStatesAction'>
            <on eventId='allLinesDelivered' newStateId='DELIVERED'/>
            <on eventId='anyLineCancelled' newStateId='CANCELLED'/>
        </manual-state>

        <!-- Delivered -->
        <manual-state id='DELIVERED'>
            <on eventId='lineStatusUpdated' componentName='updateOrderStatusFromLine'/>
        </manual-state>

        <!-- Cancelled -->
        <manual-state id='CANCELLED'/>
    </flow>
</states>
