<?xml version="1.0" encoding="UTF-8"?>
<states>
    <!-- ======= EVENT DEFINITIONS ======= -->
    <event-information eventId='addOrderLine' meta-bodyType='com.handmade.ecommerce.orderline.payload.AddOrderLinePayload'/>
    <event-information eventId='confirmStock' meta-bodyType='com.handmade.ecommerce.orderline.payload.ConfirmStockPayload'/>
    <event-information eventId='prepareItem' meta-bodyType='com.handmade.ecommerce.orderline.payload.PrepareItemPayload'/>
    <event-information eventId='itemReady' meta-bodyType='com.handmade.ecommerce.orderline.payload.ItemReadyPayload'/>
    <event-information eventId='shipItem' meta-bodyType='com.handmade.ecommerce.orderline.payload.ShipItemPayload'/>
    <event-information eventId='inTransit' meta-bodyType='com.handmade.ecommerce.orderline.payload.InTransitPayload'/>
    <event-information eventId='deliverItem' meta-bodyType='com.handmade.ecommerce.orderline.payload.DeliverItemPayload'/>
    <event-information eventId='returnInitiated' meta-bodyType='com.handmade.ecommerce.orderline.payload.ReturnInitiatedPayload'/>
    <event-information eventId='returnReceived' meta-bodyType='com.handmade.ecommerce.orderline.payload.ReturnReceivedPayload'/>
    <event-information eventId='refundProcessed' meta-bodyType='com.handmade.ecommerce.orderline.payload.RefundProcessedPayload'/>
    <event-information eventId='cancelItem' meta-bodyType='com.handmade.ecommerce.orderline.payload.CancelItemPayload'/>
    <event-information eventId='sellerCancel' meta-bodyType='com.handmade.ecommerce.orderline.payload.SellerCancelPayload'/>
    <event-information eventId='buyerCancel' meta-bodyType='com.handmade.ecommerce.orderline.payload.BuyerCancelPayload'/>
    <event-information eventId='replaceItem' meta-bodyType='com.handmade.ecommerce.orderline.payload.ReplaceItemPayload'/>
    <event-information eventId='updatePrice' meta-bodyType='com.handmade.ecommerce.orderline.payload.UpdatePricePayload'/>
    <event-information eventId='modifyQuantity' meta-bodyType='com.handmade.ecommerce.orderline.payload.ModifyQuantityPayload'/>
    <event-information eventId='rateItem' meta-bodyType='com.handmade.ecommerce.orderline.payload.RateItemPayload'/>

    <!-- ======= FLOW DEFINITION ======= -->
    <flow id='orderLine-flow' default='true'>
        <entry-action componentName='orderLineEntryAction'/>
        <exit-action componentName='orderLineExitAction'/>

        <!-- ====== CART STATES ====== -->
        <manual-state id="CART" initialState="true">
            <on eventId="addOrderline" componentName="addOrderLineService" newStateId="CHECK_ON_SALE_OR_NOT"/>
        </manual-state>

        <auto-state id="CHECK_ON_SALE_OR_NOT" componentName="checkIfOrderLineOnSaleService">
            <on eventId="onSale" newStateId="CHECK_STOCK_AFTER_ONSALE"/>
            <on eventId="notOnSale" newStateId="CHECK_STOCK_AFTER_NOTSALE"/>
        </auto-state>

        <!-- ====== STOCK CHECK ====== -->
        <auto-state id="CHECK_STOCK_AFTER_ONSALE" componentName="checkIfOrderLineItemInStockService">
            <on eventId="outOfQuantity" newStateId="REMOVED"/>
            <on eventId="inStock" newStateId="ON_SALE_IN_STOCK"/>
            <on eventId="outOfStock" newStateId="OUT_OF_STOCK"/>
        </auto-state>

        <auto-state id="CHECK_STOCK_AFTER_NOTSALE" componentName="checkIfOrderLineItemInStockService">
            <on eventId="outOfQuantity" newStateId="REMOVED"/>
            <on eventId="inStock" newStateId="NON_SALE_IN_STOCK"/>
            <on eventId="outOfStock" newStateId="OUT_OF_STOCK"/>
        </auto-state>


        <manual-state id="ON_SALE_IN_STOCK">
            <on eventId="addItem" componentName="addOrderLineService" newStateId="CHECK_ON_SALE_OR_NOT" />
            <on eventId="removeItem" componentName="removeItemActionService" newStateId="REMOVED" />
            <on eventId="incrementQty" componentName="cartItemIncrementQtyService" newStateId="CHECK_ON_SALE_OR_NOT"/>
            <on eventId="decrementQty" componentName="cartItemDecrementQtyService" newStateId="CHECK_ON_SALE_OR_NOT" />
            <on eventId="updateQuantity" componentName="updateQuantityOrderLineItemService" newStateId="CHECK_ON_SALE_OR_NOT" />
            <on eventId="updatePrice" componentName="updatePriceOrderLineItemService" newStateId="CHECK_ON_SALE_OR_NOT" />
            <on eventId="refreshOrderLineItem" componentName="checkReStockOrderLineItemService" newStateId="CHECK_IN_STOCK" />
            <on eventId="paymentSucessFull" componentName="" newStateId="PENDING_SELLER_PREPARATION"/>
            <on eventId="paymentSucessFull" newStateId="PENDING_SELLER_PREPARATION"/>
        </manual-state>

        <manual-state id="NON_SALE_IN_STOCK">
            <on eventId="addItem" componentName="addItemActionService" newStateId="CHECK_ON_SALE_OR_NOT" />
            <on eventId="removeItem" componentName="removeItemActionService" newStateId="REMOVED" />
            <on eventId="incrementQty" componentName="cartItemIncrementQtyService" newStateId="CHECK_ON_SALE_OR_NOT"/>
            <on eventId="decrementQty" componentName="cartItemDecrementQtyService" newStateId="CHECK_ON_SALE_OR_NOT" />
            <on eventId="updateQuantity" componentName="updateQuantityOrderLineItemService" newStateId="CHECK_ON_SALE_OR_NOT" />
            <on eventId="updatePrice" componentName="updatePriceOrderLineItemService" newStateId="CHECK_ON_SALE_OR_NOT" />
            <on eventId="refreshOrderLineItem" componentName="checkReStockOrderLineItemService" newStateId="CHECK_IN_STOCK" />
            <on eventId="paymentSucessFull" newStateId="PENDING_SELLER_PREPARATION"/>
        </manual-state>

        <!-- ====== OUT OF STOCK ====== -->
        <manual-state id="OUT_OF_STOCK">
            <on eventId="refreshOrderLineItem" componentName="checkReStockOrderLineItemService" newStateId="CHECK_ON_SALE_OR_NOT"/>
            <on eventId="remove" componentName="removeItemActionService" newStateId="REMOVED"/>
        </manual-state>

        <manual-state id="REMOVED"/>

        <!-- ====== SELLER PREPARATION ====== -->
        <manual-state id='PENDING_SELLER_PREPARATION'>
            <on eventId='prepareItem' componentName='prepareItemAction' newStateId='PREPARING'/>
            <on eventId='sellerCancel' componentName='sellerCancelAction' newStateId='CANCELLED'/>
        </manual-state>

        <manual-state id='PREPARING'>
            <on eventId='itemReady' componentName='itemReadyAction' newStateId='READY_TO_DISPATCH'/>
            <on eventId='sellerCancel' componentName='sellerCancelAction' newStateId='CANCELLED'/>
        </manual-state>

        <manual-state id='READY_TO_DISPATCH'>
            <on eventId='shipItem' componentName='shipItemAction' newStateId='SHIPPED'/>
        </manual-state>

        <!-- ====== IN TRANSIT / DELIVERED ====== -->
        <manual-state id='SHIPPED'>
            <on eventId='inTransit' componentName='inTransitAction'/>
            <on eventId='deliverItem' componentName='deliverItemAction' newStateId='DELIVERED'/>
            <on eventId='buyerCancel' componentName='buyerCancelAction' newStateId='CANCELLED'/>
        </manual-state>

        <manual-state id='DELIVERED'>
            <on eventId='rateItem' componentName='rateItemAction'/>
            <on eventId='returnInitiated' componentName='returnInitiatedAction' newStateId='RETURN_INITIATED'/>
        </manual-state>

        <!-- ====== RETURNS & REFUNDS ====== -->
        <manual-state id='RETURN_INITIATED'>
            <on eventId='returnReceived' componentName='returnReceivedAction' newStateId='RETURN_RECEIVED'/>
        </manual-state>

        <manual-state id='RETURN_RECEIVED'>
            <on eventId='refundProcessed' componentName='refundProcessedAction' newStateId='REFUNDED'/>
            <on eventId='replaceItem' componentName='replaceItemAction' newStateId='PREPARING'/>
        </manual-state>

        <manual-state id='REFUNDED'/>

        <!-- ====== CANCELLED ====== -->
        <manual-state id='CANCELLED'/>
    </flow>
</states>