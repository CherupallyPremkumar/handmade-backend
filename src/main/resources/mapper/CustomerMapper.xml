<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.homebase.ecom.mapper.CustomerMapper">

    <!-- Result Map for CustomerEntity -->
    <resultMap id="customerResultMap" type="com.homebase.ecom.domain.Customer">
        <id property="id" column="id"/>
        <result property="name" column="name"/>
        <result property="email" column="email"/>
        <result property="password" column="password"/>
        <result property="phone" column="phone"/>
        <result property="orderCount" column="order_count"/>
        <result property="totalSpent" column="total_spent"/>
        <result property="roles" column="roles" typeHandler="com.homebase.ecom.mapper.typehandler.StringListTypeHandler"/>
        <result property="tenantId" column="tenant_id"/>
        <result property="createdAt" column="created_at"/>
        <result property="updatedAt" column="updated_at"/>
        <result property="deleted" column="deleted"/>
    </resultMap>

    <!-- Find customer by email -->
    <select id="findByEmailAndTenantId" resultMap="customerResultMap">
        SELECT * FROM customers 
        WHERE email = #{email} AND tenant_id = #{tenantId} AND deleted = false
    </select>

    <!-- Find customer by ID -->
    <select id="findByIdAndTenantId" resultMap="customerResultMap">
        SELECT * FROM customers 
        WHERE id = #{id} AND tenant_id = #{tenantId} AND deleted = false
    </select>

    <!-- Find all customers by tenant -->
    <select id="findAllByTenantId" resultMap="customerResultMap">
        SELECT * FROM customers 
        WHERE tenant_id = #{tenantId} AND deleted = false 
        ORDER BY created_at DESC
    </select>

    <!-- Search customers by name -->
    <select id="searchByNameAndTenantId" resultMap="customerResultMap">
        SELECT * FROM customers 
        WHERE name LIKE CONCAT('%', #{search}, '%') 
        AND tenant_id = #{tenantId} AND deleted = false
    </select>

    <!-- Count customers by tenant -->
    <select id="countByTenantId" resultType="long">
        SELECT COUNT(*) FROM customers 
        WHERE tenant_id = #{tenantId} AND deleted = false
    </select>

    <!-- Check if email exists -->
    <select id="existsByEmailAndTenantId" resultType="boolean">
        SELECT EXISTS(
            SELECT 1 FROM customers 
            WHERE email = #{email} AND tenant_id = #{tenantId} AND deleted = false
        )
    </select>

</mapper>
