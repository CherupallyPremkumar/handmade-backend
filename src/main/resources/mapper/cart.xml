<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="Cart">

    <resultMap id="carts" type="com.homebase.ecom.mybatis.cart.CartDto">
        <id column="cartId" property="id"/>
        <result column="status" property="status"/>
        <result column="customerId" property="customerId"/>
        <result column="txn" property="txn"/>
        <result column="taxAmount" property="taxAmount"/>
        <result column="totalAmount" property="totalAmount"/>
        <result column="transactionAmount" property="transactionAmount"/>
        <collection property="cartItems" ofType="com.homebase.ecom.mybatis.cart.CartItemsDto" resultMap="cartItemMap"/>
    </resultMap>

    <resultMap id="cartItemMap" type="com.homebase.ecom.mybatis.cart.CartItemsDto">
        <id column="cartItemId" property="cartItemId"/>
        <result column="productId" property="productId"/>
        <result column="quantity" property="quantity"/>
        <result column="productVariantId" property="productVariantId"/>
        <result column="description" property="description"/>
        <result column="price" property="price"/>
        <result column="olTotalAmount" property="totalAmount"/>
        <result column="cartItemTenantId" property="tenantId"/>
        <result column="quantityAvailable" property="quantityAvailable"/>
        <result column="displayName" property="displayName"/>
        <result column="thumbnail" property="thumbnail"/>
        <result column="createdTime" property="createdTime"/>
        <result column="createdBy" property="createdBy"/>
        <result column="lastModifiedTime" property="updatedTime"/>
        <result column="lastModifiedBy" property="updatedBy"/>
    </resultMap>

    <select id="getByCartId" resultMap="carts">
        WITH cart_cte AS (
        SELECT
        id,
        state_id,
        flow_id,
        customer_id,
        txn,
        tax_amount,
        discount,
        total_amount,
        transaction_amount,
        tenant
        FROM hm_cart
        <where>
            id= #{cart_id}
        </where>
        )
        SELECT
        cart_cte.id AS cartId,
        cart_cte.state_id AS status,
        cart_cte.customer_id AS customerId,
        cart_cte.txn AS txn,
        cart_cte.tax_amount AS taxAmount,
        cart_cte.total_amount AS totalAmount,
        cart_cte.transaction_amount AS transactionAmount,
        cart_cte.tenant AS tenantId,
        ol.id AS cartItemId,
        ol.tenant AS cartItemTenantId,
        pv.id AS productVariantId,
        p.id AS productId,
        ol.quantity AS quantity,
        ol.created_time AS createdTime,
        ol.created_by AS createdBy,
        ol.last_modified_time AS updatedTime,
        ol.last_modified_by AS updatedBy,
        ol.tenant AS tenantId,
        COALESCE(pr.price::numeric, 0.00) as price,
        ol.total_amount As olTotalAmount,
        i.quantity_available as quantityAvailable,
        i.location_id as inventoryLocationId,
        pv.display_name As displayName,
        pv.description as description,
        img.url as thumbnail
        FROM cart_cte
        JOIN hm_cart_item AS ol ON cart_cte.id = ol.cart_id
        INNER JOIN hm_product_variant AS pv ON ol.product_variant_id = pv.id
        INNER JOIN hm_product AS p ON pv.product_id = p.id
        INNER JOIN hm_image AS img ON pv.id = img.product_variant_id
        INNER JOIN hm_price pr ON ol.product_variant_id = pr.product_variant_id
        INNER JOIN hm_inventory AS i ON ol.product_variant_id = i.product_variant_id
        INNER JOIN hm_location AS l ON l.id = i.location_id
        INNER JOIN hm_tenant AS t ON t.id = ol.sub_tenant_id
        <where>
            <if test="location_id != null">
                AND i.location_id = #{location_id}
            </if>
        </where>
        ${orderby}
    </select>


    <select id="cartCount" resultType="map">
        SELECT
            COALESCE(COUNT(ci.id), 0) AS count
        FROM hm_cart_item ci
        WHERE ci.cart_id = #{cart_id}
    </select>
</mapper>
