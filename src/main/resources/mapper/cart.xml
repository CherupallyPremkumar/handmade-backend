<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="Cart">

    <resultMap id="carts" type="com.homebase.ecom.mybatis.cart.CartDto">
        <id column="cartId" property="id"/>
        <result column="status" property="status"/>
        <result column="customerId" property="customerId"/>
        <result column="txn" property="txn"/>
        <result column="taxAmount" property="taxAmount"/>
        <result column="totalAmount" property="totalAmount"/>
        <result column="transactionAmount" property="transactionAmount"/>
        <collection property="cartItems" ofType="com.homebase.ecom.mybatis.cart.CartItemsDto" resultMap="cartItemMap"/>
    </resultMap>

    <resultMap id="cartItemMap" type="com.homebase.ecom.mybatis.cart.CartItemsDto">
        <id column="cartItemId" property="cartItemId"/>
        <result column="productId" property="productId"/>
        <result column="quantity" property="quantity"/>
        <result column="productVariantId" property="productVariantId"/>
        <result column="description" property="description"/>
        <result column="price" property="price"/>
        <result column="olTotalAmount" property="totalAmount"/>
        <result column="tenantId" property="tenantId"/>
        <result column="quantityAvailable" property="quantityAvailable"/>
        <result column="displayName" property="displayName"/>
        <result column="thumbnail" property="thumbnail"/>
        <result column="createdTime" property="createdTime"/>
        <result column="createdBy" property="createdBy"/>
        <result column="updatedTime" property="updatedTime"/>
        <result column="updatedBy" property="updatedBy"/>
    </resultMap>

    <select id="getByCartId" resultMap="carts">
        WITH cart_cte AS (
            SELECT *
            FROM hm_cart
            <where>
                <if test="customer_id != null">
                    customer_id = #{customer_id}
                </if>
            </where>
        )
        SELECT
            c.id AS cartId,
            c.state_id AS status,
            c.customer_id AS customerId,
            c.txn AS txn,
            c.tax_amount AS taxAmount,
            c.total_amount AS totalAmount,
            c.transaction_amount AS transactionAmount,
            ci.id AS cartItemId,
            ci.tenant AS tenantId,
            pv.id AS productVariantId,
            p.id AS productId,
            ci.quantity AS quantity,
            ci.created_time AS createdTime,
            ci.created_by AS createdBy,
            ci.last_modified_time AS updatedTime,
            ci.last_modified_by AS updatedBy,
            COALESCE(pr.price::numeric, 0.00) AS price,
            ci.total_amount AS olTotalAmount,
            i.quantity_available AS quantityAvailable,
            i.location_id AS inventoryLocationId,
            pv.display_name AS displayName,
            pv.description AS description,
            img.url AS thumbnail
        FROM cart_cte c
        JOIN hm_cart_item ci ON c.id = ci.cart_id
        INNER JOIN hm_product_variant pv ON ci.product_variant_id = pv.id
        INNER JOIN hm_product p ON pv.product_id = p.id
        LEFT JOIN hm_image img ON pv.id = img.product_variant_id
        LEFT JOIN hm_price pr ON ci.product_variant_id = pr.product_variant_id
        LEFT JOIN hm_inventory i ON ci.product_variant_id = i.product_variant_id
        LEFT JOIN hm_location l ON l.id = i.location_id
        LEFT JOIN hm_tenant t ON t.id = ci.tenant
        <where>
            <if test="location_id != null">
                AND i.location_id = #{location_id}
            </if>
        </where>
        ${orderby}
    </select>
</mapper>
