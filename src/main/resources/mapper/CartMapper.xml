<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.homebase.ecom.mapper.CartMapper">

    <!-- Result Map for CartEntity -->
    <resultMap id="cartResultMap" type="com.homebase.ecom.domain.Cart">
        <id property="id" column="id"/>
        <result property="customerId" column="customer_id"/>
        <result property="tenantId" column="tenant_id"/>
        <result property="createdAt" column="created_at"/>
        <result property="updatedAt" column="updated_at"/>
        <result property="deleted" column="deleted"/>
    </resultMap>

    <!-- Result Map for CartItem with Product details -->
    <resultMap id="cartItemResultMap" type="com.homebase.ecom.domain.CartItem">
        <id property="id" column="id"/>
        <result property="cartId" column="cart_id"/>
        <result property="productId" column="product_id"/>
        <result property="quantity" column="quantity"/>
        <result property="priceAtAdd" column="price_at_add"/>
        <result property="tenantId" column="tenant_id"/>
        <result property="createdAt" column="created_at"/>
        <result property="updatedAt" column="updated_at"/>
    </resultMap>

    <!-- Find cart by customer ID and tenant -->
    <select id="findByCustomerIdAndTenantId" resultMap="cartResultMap">
        SELECT * FROM carts 
        WHERE customer_id = #{customerId} AND tenant_id = #{tenantId}
    </select>

    <!-- Find cart items by cart ID -->
    <select id="findCartItemsByCartId" resultMap="cartItemResultMap">
        SELECT 
            ci.*,
            p.name as product_name,
            p.price as product_price,
            p.image_url as product_image
        FROM cart_items ci
        JOIN products p ON ci.product_id = p.id
        WHERE ci.cart_id = #{cartId} AND ci.tenant_id = #{tenantId}
    </select>

    <!-- Find cart item by ID -->
    <select id="findCartItemById" resultMap="cartItemResultMap">
        SELECT * FROM cart_items 
        WHERE id = #{id} AND tenant_id = #{tenantId}
    </select>

    <!-- Find cart item by cart and product -->
    <select id="findCartItemByCartAndProduct" resultMap="cartItemResultMap">
        SELECT * FROM cart_items 
        WHERE cart_id = #{cartId} AND product_id = #{productId} AND tenant_id = #{tenantId}
    </select>

    <!-- Calculate cart total -->
    <select id="calculateCartTotal" resultType="java.math.BigDecimal">
        SELECT COALESCE(SUM(ci.quantity * ci.price_at_add), 0)
        FROM cart_items ci
        WHERE ci.cart_id = #{cartId} AND ci.tenant_id = #{tenantId}
    </select>

    <!-- Count cart items -->
    <select id="countCartItems" resultType="int">
        SELECT COUNT(*) FROM cart_items 
        WHERE cart_id = #{cartId} AND tenant_id = #{tenantId}
    </select>

</mapper>
