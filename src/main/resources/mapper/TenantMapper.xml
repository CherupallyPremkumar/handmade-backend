<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.homebase.admin.mapper.TenantMapper">

    <!-- Result Map for Tenant with Configuration -->
    <resultMap id="tenantWithConfig" type="com.homebase.admin.entity.Tenant">
        <id property="id" column="id"/>
        <result property="tenantCode" column="tenant_code"/>
        <result property="tenantName" column="tenant_name"/>
        <result property="displayName" column="display_name"/>
        <result property="urlPath" column="url_path"/>
        <result property="logoUrl" column="logo_url"/>
        <result property="currency" column="currency"/>
        <result property="locale" column="locale"/>
        <result property="timezone" column="timezone"/>
        <result property="supportEmail" column="support_email"/>
        <result property="supportPhone" column="support_phone"/>
        <!-- Embedded TenantTheme -->
        <result property="theme.primaryColor" column="theme_primary_color"/>
        <result property="theme.secondaryColor" column="theme_secondary_color"/>
        <result property="theme.background" column="theme_background"/>
        <result property="theme.text" column="theme_text"/>
        <association property="configuration" javaType="com.homebase.admin.entity.TenantConfiguration">
            <id property="id" column="config_id"/>
            <result property="primaryColor" column="primary_color"/>
            <result property="secondaryColor" column="secondary_color"/>
            <result property="enablePromotions" column="enable_promotions"/>
            <result property="enableReviews" column="enable_reviews"/>
            <result property="tenantId" column="config_tenant_id"/>
            <result property="createdAt" column="config_created_at"/>
            <result property="updatedAt" column="config_updated_at"/>
        </association>
    </resultMap>

    <!-- Find tenant by URL path -->
    <select id="findByUrlPath" parameterType="string" resultMap="tenantWithConfig">
        SELECT 
            t.id,
            t.tenant_code,
            t.tenant_name,
            t.display_name,
            t.url_path,
            t.logo_url,
            t.currency,
            t.locale,
            t.timezone,
            t.support_email,
            t.support_phone,
            t.primary_color as theme_primary_color,
            t.secondary_color as theme_secondary_color,
            t.background as theme_background,
            t.text as theme_text,
            tc.id as config_id,
            tc.primary_color,
            tc.secondary_color,
            tc.enable_promotions,
            tc.enable_reviews,
            tc.tenant_id as config_tenant_id,
            tc.created_at as config_created_at,
            tc.updated_at as config_updated_at
        FROM tenants t
        LEFT JOIN tenant_configuration tc ON t.configuration_id = tc.id
        WHERE t.url_path = #{urlPath}
    </select>

    <!-- Find tenant by ID -->
    <select id="findById" parameterType="long" resultMap="tenantWithConfig">
        SELECT 
            t.id,
            t.tenant_code,
            t.tenant_name,
            t.display_name,
            t.url_path,
            t.logo_url,
            t.currency,
            t.locale,
            t.timezone,
            t.support_email,
            t.support_phone,
            t.primary_color as theme_primary_color,
            t.secondary_color as theme_secondary_color,
            t.background as theme_background,
            t.text as theme_text,
            tc.id as config_id,
            tc.primary_color,
            tc.secondary_color,
            tc.enable_promotions,
            tc.enable_reviews,
            tc.tenant_id as config_tenant_id,
            tc.created_at as config_created_at,
            tc.updated_at as config_updated_at
        FROM tenants t
        LEFT JOIN tenant_configuration tc ON t.configuration_id = tc.id
        WHERE t.id = #{id}
    </select>

    <!-- Find tenant by tenant code -->
    <select id="findByTenantCode" parameterType="string" resultMap="tenantWithConfig">
        SELECT 
            t.id,
            t.tenant_code,
            t.tenant_name,
            t.display_name,
            t.url_path,
            t.logo_url,
            t.currency,
            t.locale,
            t.timezone,
            t.support_email,
            t.support_phone,
            t.primary_color as theme_primary_color,
            t.secondary_color as theme_secondary_color,
            t.background as theme_background,
            t.text as theme_text,
            tc.id as config_id,
            tc.primary_color,
            tc.secondary_color,
            tc.enable_promotions,
            tc.enable_reviews,
            tc.tenant_id as config_tenant_id,
            tc.created_at as config_created_at,
            tc.updated_at as config_updated_at
        FROM tenants t
        LEFT JOIN tenant_configuration tc ON t.configuration_id = tc.id
        WHERE t.tenant_code = #{tenantCode}
    </select>

    <!-- Find all tenants -->
    <select id="findAllTenants" resultMap="tenantWithConfig">
        SELECT 
            t.id,
            t.tenant_code,
            t.tenant_name,
            t.display_name,
            t.url_path,
            t.logo_url,
            t.currency,
            t.locale,
            t.timezone,
            t.support_email,
            t.support_phone,
            t.primary_color as theme_primary_color,
            t.secondary_color as theme_secondary_color,
            t.background as theme_background,
            t.text as theme_text,
            tc.id as config_id,
            tc.primary_color,
            tc.secondary_color,
            tc.enable_promotions,
            tc.enable_reviews,
            tc.tenant_id as config_tenant_id,
            tc.created_at as config_created_at,
            tc.updated_at as config_updated_at
        FROM tenants t
        LEFT JOIN tenant_configuration tc ON t.configuration_id = tc.id
        ORDER BY t.tenant_name ASC
    </select>

    <!-- Check if URL path exists -->
    <select id="existsByUrlPath" parameterType="string" resultType="boolean">
        SELECT EXISTS(SELECT 1 FROM tenants WHERE url_path = #{urlPath})
    </select>

    <!-- Check if tenant code exists -->
    <select id="existsByTenantCode" parameterType="string" resultType="boolean">
        SELECT EXISTS(SELECT 1 FROM tenants WHERE tenant_code = #{tenantCode})
    </select>

    <!-- Count tenants -->
    <select id="countTenants" resultType="long">
        SELECT COUNT(*) FROM tenants
    </select>


</mapper>
