<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="ProductVariant">

    <resultMap id="variant" type="map">
        <id property="internalId" column="internal_id"/>
        <result property="createdTime" column="created_time"/>
        <result property="createdBy" column="created_by"/>
        <result property="catId" column="cat_id"/>
        <result property="productId" column="product_id"/>
        <result property="variantId" column="tenant_id"/>
        <result property="displayName" column="display_name"/>
        <result property="description" column="description"/>
        <result property="price" column="price"/>
        <result property="name" column="name"/>
    </resultMap>

    <select id="getAll" resultMap="variant">
        SELECT
        pv.id AS internal_id,
        pv.name as name,
        pv.created_time,
        pv.created_by,
        pv.description,
        pv.display_name,
        pv.cat_id,
        COALESCE(pr.amount, 0.00) AS price,
        pv.sku,
        pv.product_id,
        pv.thumbnail
        t.id AS tenant_id,
        FROM hm_product_variant pv
        LEFT JOIN hm_image img ON img.product_variant_id = pv.id
        LEFT JOIN hm_price pr ON pr.product_variant_id = pv.id
        INNER JOIN hm_product p ON p.id = pv.product_id
        INNER JOIN hm_category c ON c.id = pv.cat_id
        INNER JOIN hm_tenant t ON t.id = pv.tenant
        <trim prefix="WHERE" prefixOverrides="AND|OR">
            <if test="searchString != null and searchString.trim().length() > 0">
                AND (
                UPPER(pv.display_name) LIKE CONCAT('%', UPPER(#{searchString}), '%') OR
                UPPER(pv.name) LIKE CONCAT('%', UPPER(#{searchString}), '%') OR
                UPPER(pv.description) LIKE CONCAT('%', UPPER(#{searchString}), '%')
                )
            </if>
            <if test="size != null and size.size() > 0">
                AND size IN
                <foreach item="item" index="index" collection="size"
                         open="(" separator="," close=")">
                    #{item}
                </foreach>
            </if>
            <if test="color != null and color != ''">
                AND color = #{color}
            </if>
        </trim>
        ${orderby} ${pagination}
    </select>

    <select id="getAll-count" resultType="int">
        SELECT COUNT(*)
        FROM hm_product_variant pv
        LEFT JOIN hm_image img ON img.product_variant_id = pv.id
        LEFT JOIN hm_price pr ON pr.product_variant_id = pv.id
        INNER JOIN hm_product p ON p.id = pv.product_id
        INNER JOIN hm_category c ON c.id = pv.cat_id
        INNER JOIN hm_tenant t ON t.id = pv.tenant
        <trim prefix="WHERE" prefixOverrides="AND|OR">
            tenant = #{tenant_id}
            <if test="searchString != null and searchString.length() > 0">
                AND (
                UPPER(display_name) LIKE UPPER(CONCAT('%', #{searchString}, '%')) OR
                UPPER(name) LIKE UPPER(CONCAT('%', #{searchString}, '%')) OR
                UPPER(description) LIKE UPPER(CONCAT('%', #{searchString}, '%'))
                )
            </if>
            <if test="size != null and size != ''">
                AND size = #{size}
            </if>
            <if test="color != null and color != ''">
                AND color = #{color}
            </if>
        </trim>
    </select>

    <select id="getByVariantId" resultMap="variant">
        SELECT
        pv.id AS internal_id,
        pv.name,
        pv.created_time,
        pv.created_by,
        pv.description,
        pv.display_name,
        pv.cat_id,
        COALESCE(pr.amount, 0.00) AS price,
        pv.sku,
        pv.product_id,
        pv.thumbnail
        pr.price AS price
        pr.discountPercentage AS discount_percentage
        a.id AS artisan_id
        a.name AS artisan_name
        p.id AS product_id
        p.description AS product_description
        p.feature_description AS feature_description
        p.sales_description AS sales_description
        p.details AS product_details
        c.id AS category_id
        c.name AS category_name
        t.id AS tenant_id
        t.name AS tenant_name
        FROM hm_product_variant pv
        LEFT JOIN hm_image img ON img.product_variant_id = pv.id
        LEFT JOIN hm_price pr ON pr.product_variant_id = pv.id
        INNER JOIN hm_product p ON p.id = pv.product_id
        INNER JOIN hm_category c ON c.id = pv.cat_id
        INNER JOIN hm_tenant t ON t.id = pv.tenant
        INNER JOIN hm_artisan a ON a.id = p.artisan_id
        <trim prefix="WHERE" prefixOverrides="AND|OR">
            pv.tenant = #{tenant_id}
            AND pv.id = #{id}
        </trim>
    </select>
</mapper>
