<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.homebase.admin.mapper.OrderMapper">

    <!-- Result Map for Order -->
    <resultMap id="orderResultMap" type="com.homebase.admin.entity.Order">
        <id property="id" column="id"/>
        <result property="orderNumber" column="order_number"/>
        <result property="customerId" column="customer_id"/>
        <result property="customerName" column="customer_name"/>
        <result property="customerEmail" column="customer_email"/>
        <result property="customerPhone" column="customer_phone"/>
        <result property="shippingAddress" column="shipping_address"/>
        <result property="city" column="city"/>
        <result property="state" column="state"/>
        <result property="pincode" column="pincode"/>
        <result property="subtotal" column="subtotal"/>
        <result property="tax" column="tax"/>
        <result property="shippingCost" column="shipping_cost"/>
        <result property="total" column="total"/>
        <result property="status" column="status"/>
        <result property="paymentStatus" column="payment_status"/>
        <result property="transactionId" column="transaction_id"/>
        <result property="tenantId" column="tenant_id"/>
        <result property="createdAt" column="created_at"/>
        <result property="updatedAt" column="updated_at"/>
        <result property="deleted" column="deleted"/>
    </resultMap>

    <!-- Result Map for OrderItem -->
    <resultMap id="orderItemResultMap" type="com.homebase.admin.entity.OrderItem">
        <id property="id" column="id"/>
        <result property="orderId" column="order_id"/>
        <result property="productId" column="product_id"/>
        <result property="productName" column="product_name"/>
        <result property="quantity" column="quantity"/>
        <result property="price" column="price"/>
        <result property="tenantId" column="tenant_id"/>
        <result property="createdAt" column="created_at"/>
        <result property="updatedAt" column="updated_at"/>
        <result property="deleted" column="deleted"/>
    </resultMap>

    <!-- Find orders by customer -->
    <select id="findByCustomerIdAndTenantId" resultMap="orderResultMap">
        SELECT * FROM orders 
        WHERE customer_id = #{customerId} AND tenant_id = #{tenantId} AND deleted = false 
        ORDER BY created_at DESC
    </select>

    <!-- Find order by ID -->
    <select id="findByIdAndTenantId" resultMap="orderResultMap">
        SELECT * FROM orders 
        WHERE id = #{id} AND tenant_id = #{tenantId} AND deleted = false
    </select>

    <!-- Find order by order number -->
    <select id="findByOrderNumberAndTenantId" resultMap="orderResultMap">
        SELECT * FROM orders 
        WHERE order_number = #{orderNumber} AND tenant_id = #{tenantId} AND deleted = false
    </select>

    <!-- Find orders by status -->
    <select id="findByStatusAndTenantId" resultMap="orderResultMap">
        SELECT * FROM orders 
        WHERE status = #{status} AND tenant_id = #{tenantId} AND deleted = false 
        ORDER BY created_at DESC
    </select>

    <!-- Find orders by payment status -->
    <select id="findByPaymentStatusAndTenantId" resultMap="orderResultMap">
        SELECT * FROM orders 
        WHERE payment_status = #{paymentStatus} AND tenant_id = #{tenantId} AND deleted = false 
        ORDER BY created_at DESC
    </select>

    <!-- Find all orders with pagination -->
    <select id="findAllByTenantIdPaginated" resultMap="orderResultMap">
        SELECT * FROM orders 
        WHERE tenant_id = #{tenantId} AND deleted = false 
        ORDER BY created_at DESC 
        LIMIT #{limit} OFFSET #{offset}
    </select>

    <!-- Find order items by order ID -->
    <select id="findOrderItemsByOrderId" resultMap="orderItemResultMap">
        SELECT * FROM order_items 
        WHERE order_id = #{orderId} AND tenant_id = #{tenantId}
    </select>

    <!-- Count orders by tenant -->
    <select id="countByTenantId" resultType="long">
        SELECT COUNT(*) FROM orders 
        WHERE tenant_id = #{tenantId} AND deleted = false
    </select>

    <!-- Count orders by status -->
    <select id="countByStatusAndTenantId" resultType="long">
        SELECT COUNT(*) FROM orders 
        WHERE status = #{status} AND tenant_id = #{tenantId} AND deleted = false
    </select>

    <!-- Get total revenue -->
    <select id="getTotalRevenue" resultType="java.math.BigDecimal">
        SELECT COALESCE(SUM(total), 0) FROM orders 
        WHERE payment_status = 'PAID' AND tenant_id = #{tenantId} AND deleted = false
    </select>

    <!-- Get revenue by date range -->
    <select id="getRevenueByDateRange" resultType="java.math.BigDecimal">
        SELECT COALESCE(SUM(total), 0) FROM orders 
        WHERE payment_status = 'PAID' AND tenant_id = #{tenantId}
        AND created_at >= #{startDate} AND created_at &lt;= #{endDate}
        AND deleted = false
    </select>

</mapper>
