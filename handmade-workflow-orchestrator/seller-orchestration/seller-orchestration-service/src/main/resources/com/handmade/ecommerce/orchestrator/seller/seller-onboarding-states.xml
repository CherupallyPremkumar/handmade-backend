<?xml version="1.0" encoding="UTF-8"?>
<!--
Seller Onboarding State Machine
Maps to chains in seller-onboarding.xml

Chain Mapping:
- policy-and-seller-chain → DRAFT state
- start-onboarding-chain → ONBOARDING state
- identity-verification-chain → IDENTITY_VERIFICATION state
- tax-verification-chain → TAX_VERIFICATION state
- bank-verification-chain → BANK_VERIFICATION state
- compliance-and-approval-chain → PENDING_APPROVAL → APPROVED/REJECTED
-->
<states>
    <flow id='SELLER_ONBOARDING_FLOW' default="true">
        
        <!-- ============================================================ -->
        <!-- CHAIN 1: policy-and-seller-chain                            -->
        <!-- ============================================================ -->
        <!-- DRAFT: Seller created, policy locked -->
        <manual-state id='DRAFT' initialState="true">
            <on eventId="start_onboarding" newStateId="ONBOARDING"/>
            <on eventId="delete" newStateId='DELETED'/>
        </manual-state>

        <!-- ============================================================ -->
        <!-- CHAIN 2: start-onboarding-chain                             -->
        <!-- ============================================================ -->
        <!-- ONBOARDING: Onboarding workflow started -->
        <manual-state id='ONBOARDING'>
            <on eventId="start_identity_verification" newStateId="IDENTITY_VERIFICATION"/>
            <on eventId="skip_to_tax" newStateId="TAX_VERIFICATION"/>
            <on eventId="skip_to_bank" newStateId="BANK_VERIFICATION"/>
            <on eventId="reject" newStateId="REJECTED"/>
        </manual-state>

        <!-- ============================================================ -->
        <!-- CHAIN 3: identity-verification-chain                        -->
        <!-- ============================================================ -->
        <!-- IDENTITY_VERIFICATION: Identity verification in progress -->
        <manual-state id='IDENTITY_VERIFICATION'>
            <on eventId="identity_verified" newStateId="TAX_VERIFICATION"/>
            <on eventId="skip_to_tax" newStateId="TAX_VERIFICATION"/>
            <on eventId="identity_failed" newStateId="IDENTITY_FAILED"/>
            <on eventId="reject" newStateId="REJECTED"/>
        </manual-state>

        <!-- IDENTITY_FAILED: Identity verification failed, needs resubmission -->
        <manual-state id='IDENTITY_FAILED'>
            <on eventId="retry_identity" newStateId="IDENTITY_VERIFICATION"/>
            <on eventId="reject" newStateId="REJECTED"/>
        </manual-state>

        <!-- ============================================================ -->
        <!-- CHAIN 4: tax-verification-chain                             -->
        <!-- ============================================================ -->
        <!-- TAX_VERIFICATION: Tax verification in progress -->
        <manual-state id='TAX_VERIFICATION'>
            <on eventId="tax_verified" newStateId="BANK_VERIFICATION"/>
            <on eventId="skip_to_bank" newStateId="BANK_VERIFICATION"/>
            <on eventId="tax_failed" newStateId="TAX_FAILED"/>
            <on eventId="reject" newStateId="REJECTED"/>
        </manual-state>

        <!-- TAX_FAILED: Tax verification failed, needs resubmission -->
        <manual-state id='TAX_FAILED'>
            <on eventId="retry_tax" newStateId="TAX_VERIFICATION"/>
            <on eventId="reject" newStateId="REJECTED"/>
        </manual-state>

        <!-- ============================================================ -->
        <!-- CHAIN 5: bank-verification-chain                            -->
        <!-- ============================================================ -->
        <!-- BANK_VERIFICATION: Bank verification in progress -->
        <manual-state id='BANK_VERIFICATION'>
            <on eventId="bank_verified" newStateId="PENDING_APPROVAL"/>
            <on eventId="bank_failed" newStateId="BANK_FAILED"/>
            <on eventId="reject" newStateId="REJECTED"/>
        </manual-state>

        <!-- BANK_FAILED: Bank verification failed, needs resubmission -->
        <manual-state id='BANK_FAILED'>
            <on eventId="retry_bank" newStateId="BANK_VERIFICATION"/>
            <on eventId="reject" newStateId="REJECTED"/>
        </manual-state>

        <!-- ============================================================ -->
        <!-- CHAIN 6: compliance-and-approval-chain                      -->
        <!-- ============================================================ -->
        <!-- PENDING_APPROVAL: All verifications complete, awaiting approval -->
        <manual-state id='PENDING_APPROVAL'>
            <on eventId="approve" newStateId="APPROVED"/>
            <on eventId="reject" newStateId="REJECTED"/>
            <on eventId="request_more_info" newStateId="INFO_REQUESTED"/>
        </manual-state>

        <!-- INFO_REQUESTED: Additional information requested -->
        <manual-state id='INFO_REQUESTED'>
            <on eventId="submit_info" newStateId="PENDING_APPROVAL"/>
            <on eventId="reject" newStateId="REJECTED"/>
        </manual-state>

        <!-- APPROVED: Seller approved, can start selling -->
        <manual-state id='APPROVED'>
            <!-- Self-transitions for updates -->
            <on eventId="update_profile"/>
            <on eventId="update_bank"/>
            <on eventId="update_tax"/>
        </manual-state>

        <!-- REJECTED: Seller rejected during verification -->
        <manual-state id='REJECTED'>
            <on eventId="reapply" newStateId="DRAFT"/>
        </manual-state>

        <!-- DELETED: Draft deleted before submission -->
        <manual-state id="DELETED"/>
        
    </flow>
</states>
