<?xml version="1.0" encoding="UTF-8"?>
<!--
Chenile OWIZ Seller Onboarding Workflow
Each chain corresponds to a state in seller-onboarding-states.xml

Flow:
1. Resolve policy
2. Create seller (DRAFT state)
3. Lock policy
4. Start onboarding (DRAFT → ONBOARDING)
5. Identity verification chain (ONBOARDING → IDENTITY_VERIFICATION)
6. Tax verification chain (IDENTITY_VERIFICATION → TAX_VERIFICATION)
7. Bank verification chain (TAX_VERIFICATION → BANK_VERIFICATION)
8. Compliance & approval chain (BANK_VERIFICATION → PENDING_APPROVAL → APPROVED/REJECTED)
-->
<flows>
    <flow id="seller-onboarding" defaultFlow="true">
        <seller-onboarding-chain>
            
            <!-- ============================================================ -->
            <!-- CHAIN 1: Policy Resolution & Seller Creation (DRAFT State)  -->
            <!-- ============================================================ -->
            <policy-and-seller-chain>
                <!-- Step 1: Resolve Onboarding Policy -->
                <resolve-policy-command/>
                
                <!-- Step 2: Create Seller in DRAFT State -->
                <create-seller-command/>
                
                <!-- Step 3: Lock Policy Version to Seller -->
                <lock-policy-command/>
            </policy-and-seller-chain>
            
            <!-- ============================================================ -->
            <!-- CHAIN 2: Start Onboarding (DRAFT → ONBOARDING)              -->
            <!-- ============================================================ -->
            <start-onboarding-chain>
                <!-- Transition to ONBOARDING State -->
                <start-onboarding-command/>
            </start-onboarding-chain>
            
            <!-- ============================================================ -->
            <!-- CHAIN 3: Identity Verification (ONBOARDING → IDENTITY_VERIFICATION) -->
            <!-- ============================================================ -->
            <identity-verification-chain>
                <!-- Check if identity verification is required -->
                <identity-verification-router expression="identityRequired">
                    <identity-provider-router expression="country" route="true">
                        <!-- US: Stripe Identity -->
                        <stripe-identity-command route="US"/>
                        
                        <!-- India: DigiLocker -->
                        <digilocker-command route="IN"/>
                        
                        <!-- EU: eIDAS -->
                        <eidas-command route="DE,FR,ES"/>
                    </identity-provider-router>
                    
                    <!-- Transition to IDENTITY_VERIFICATION state -->
                    <transition-to-identity-command route="true"/>
                </identity-verification-router>
            </identity-verification-chain>
            
            <!-- ============================================================ -->
            <!-- CHAIN 4: Tax Verification (IDENTITY_VERIFICATION → TAX_VERIFICATION) -->
            <!-- ============================================================ -->
            <tax-verification-chain>
                <!-- Check if tax verification is required -->
                <tax-verification-router expression="taxRequired">
                    <tax-provider-router expression="country" route="true">
                        <!-- US: Stripe Tax (W9) -->
                        <stripe-tax-command route="US"/>
                        
                        <!-- India: GST Verification -->
                        <gst-verification-command route="IN"/>
                        
                        <!-- EU: VAT Verification -->
                        <vat-verification-command route="DE,FR,ES"/>
                    </tax-provider-router>
                    
                    <!-- Transition to TAX_VERIFICATION state -->
                    <transition-to-tax-command route="true"/>
                </tax-verification-router>
            </tax-verification-chain>
            
            <!-- ============================================================ -->
            <!-- CHAIN 5: Bank Verification (TAX_VERIFICATION → BANK_VERIFICATION) -->
            <!-- ============================================================ -->
            <bank-verification-chain>
                <!-- Check if bank verification is required -->
                <bank-verification-router expression="bankRequired">
                    <bank-provider-router expression="country" route="true">
                        <!-- US: Stripe Connect -->
                        <stripe-connect-command route="US"/>
                        
                        <!-- India: Penny Drop -->
                        <penny-drop-command route="IN"/>
                        
                        <!-- EU: SEPA -->
                        <sepa-command route="DE,FR,ES"/>
                    </bank-provider-router>
                    
                    <!-- Transition to BANK_VERIFICATION state -->
                    <transition-to-bank-command route="true"/>
                </bank-verification-router>
            </bank-verification-chain>
            
            <!-- ============================================================ -->
            <!-- CHAIN 6: Compliance & Approval (BANK_VERIFICATION → PENDING_APPROVAL → APPROVED) -->
            <!-- ============================================================ -->
            <compliance-and-approval-chain>
                <!-- Step 7: Compliance Check -->
                <compliance-check-command/>
                
                <!-- Step 8: Final Approval (Conditional) -->
                <approval-router expression="compliancePassed">
                    <approval-chain route="true">
                        <!-- Transition to PENDING_APPROVAL -->
                        <submit-for-approval-command/>
                        
                        <!-- Auto-approve or manual review based on policy -->
                        <manual-approval-router expression="requiresManualApproval">
                            <auto-approve-command route="false"/>
                            <notify-approvers-command route="true"/>
                        </manual-approval-router>
                    </approval-chain>
                    
                    <!-- Reject if compliance failed -->
                    <reject-seller-command route="false"/>
                </approval-router>
                
                <!-- Step 9: Audit Log -->
                <audit-log-command/>
            </compliance-and-approval-chain>
            
        </seller-onboarding-chain>
    </flow>
</flows>
