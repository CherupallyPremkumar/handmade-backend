@startuml complete-checkout-flow
!theme plain
skinparam sequenceMessageAlign center

title Complete E-Commerce Checkout Flow

actor User
participant "Frontend" as Frontend
participant "Order\nService" as OrderSvc
participant "Payment\nController" as PaymentCtrl
participant "Payment\nService" as PaymentSvc
participant "Payment\nExecutor" as Executor
participant "Razorpay\nPSP" as Razorpay
participant "Wallet\nService" as WalletSvc
participant "Ledger\nService" as LedgerSvc
database "Database" as DB

== User Initiates Checkout ==
User -> Frontend: Click "Checkout"
activate Frontend

note over Frontend
    Cart has:
    - Product A (Seller 1): ₹500
    - Product B (Seller 2): ₹300
end note

== Step 1: Create Order ==
Frontend -> OrderSvc: POST /api/orders/create
activate OrderSvc

note over OrderSvc
    Creates order record
    with checkoutId
    
    Groups cart items by seller:
    - Seller 1: ₹500
    - Seller 2: ₹300
end note

OrderSvc -> DB: Save Order
DB --> OrderSvc: Order saved

OrderSvc --> Frontend: {orderId, checkoutId, sellerTotals}
deactivate OrderSvc

note over Frontend #lightblue
    Frontend generates UUIDs
    for payment order IDs
    (idempotency keys)
end note

Frontend -> Frontend: Generate paymentOrderIds\n(uuid-1, uuid-2)

== Step 2: Initiate Payment ==
Frontend -> PaymentCtrl: POST /v1/payments
activate PaymentCtrl

note over Frontend
    {
      checkoutId: "checkout-123",
      buyerId: "buyer-456",
      paymentOrders: [
        {paymentOrderId: "uuid-1", sellerId: "seller-1", amount: "500"},
        {paymentOrderId: "uuid-2", sellerId: "seller-2", amount: "300"}
      ]
    }
    
    ✓ paymentOrderIds created by Frontend
    ✓ Enables perfect idempotency on retry
end note

PaymentCtrl -> PaymentSvc: processPayment(request)
activate PaymentSvc

== Step 3: Create Payment Event ==
note over PaymentSvc #lightblue
    STEP 1: Create Payment Event
end note

PaymentSvc -> DB: Save PaymentEvent
DB --> PaymentSvc: PaymentEvent saved

== Step 4: Process Each Payment Order ==
note over PaymentSvc #lightblue
    STEP 2: Process Each Seller
end note

loop For each seller
    
    note over PaymentSvc #lightyellow
        STEP 2a: Check Idempotency
    end note
    
    PaymentSvc -> DB: findById(paymentOrderId)
    
    alt Already processed
        DB --> PaymentSvc: Existing PaymentOrder
        note over PaymentSvc #lightcoral
            Skip - already paid!
            Prevents double payment
        end note
    else New payment
        DB --> PaymentSvc: Not found
        
        PaymentSvc -> DB: Save PaymentOrder\n(status=NOT_STARTED)
        
        note over PaymentSvc #lightyellow
            STEP 2b: Execute Payment
        end note
        
        PaymentSvc -> Executor: execute(order)
        activate Executor
        
        Executor -> DB: Update status=EXECUTING
        
        Executor -> Razorpay: processPayment(order)
        activate Razorpay
        
        note right of Razorpay
            Uses order.id as
            idempotency key
        end note
        
        Razorpay -> Razorpay: Charge buyer's card ₹500
        Razorpay --> Executor: Success + token
        deactivate Razorpay
        
        Executor -> DB: Update status=SUCCESS, pspToken
        Executor --> PaymentSvc: PaymentResult{success, token}
        deactivate Executor
        
        note over PaymentSvc #lightyellow
            STEP 2c: Update Wallet
        end note
        
        PaymentSvc -> WalletSvc: credit(sellerId, ₹500)
        activate WalletSvc
        
        WalletSvc -> DB: Find Wallet by sellerId
        DB --> WalletSvc: Wallet
        
        WalletSvc -> WalletSvc: balance += ₹500
        
        WalletSvc -> DB: Update Wallet balance
        WalletSvc --> PaymentSvc: Success
        deactivate WalletSvc
        
        PaymentSvc -> DB: Update walletUpdated=true
        
        note over PaymentSvc #lightyellow
            STEP 2d: Record in Ledger
        end note
        
        PaymentSvc -> LedgerSvc: recordTransaction(order)
        activate LedgerSvc
        
        LedgerSvc -> LedgerSvc: Create transactionId
        
        LedgerSvc -> DB: Save DEBIT entry\n(buyer: -₹500)
        LedgerSvc -> DB: Save CREDIT entry\n(seller: +₹500)
        
        LedgerSvc -> DB: verifyDoubleEntry(txnId)
        DB --> LedgerSvc: sum = 0 ✓
        
        LedgerSvc --> PaymentSvc: Success
        deactivate LedgerSvc
        
        PaymentSvc -> DB: Update ledgerUpdated=true
    end
end

== Step 5: Mark Payment Complete ==
note over PaymentSvc #lightgreen
    STEP 3: Mark Complete
end note

PaymentSvc -> DB: Update isPaymentDone=true

PaymentSvc --> PaymentCtrl: PaymentResponse\n{paymentEventId, status}
deactivate PaymentSvc

PaymentCtrl --> Frontend: 200 OK
deactivate PaymentCtrl

Frontend --> User: "Payment Successful! ✓"
deactivate Frontend

note over User,DB
    **Complete Flow Summary:**
    1. Order created with checkoutId
    2. Payment event created
    3. For each seller:
       - Check idempotency (prevent double payment)
       - Execute PSP payment (Razorpay/Stripe)
       - Update wallet (credit seller)
       - Record in ledger (double-entry)
    4. Mark payment as done
end note

@enduml
