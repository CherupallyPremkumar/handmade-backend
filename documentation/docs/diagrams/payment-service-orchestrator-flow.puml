@startuml payment-service-orchestrator-flow
!theme plain
skinparam sequenceMessageAlign center

title PaymentService Orchestrator - Hosted Payment Page Flow (Two-Phase)

actor "Frontend" as Frontend
participant "PaymentProcessing\nController" as Controller
participant "PaymentProcessing\nServiceImpl\n(Orchestrator)" as Service
database "PaymentRepository" as PaymentRepo
database "PaymentOrder\nRepository" as OrderRepo
participant "PaymentExecutor" as Executor
participant "Razorpay/Stripe\nPaymentService" as PSP
participant "Webhook\nController" as Webhook
participant "WalletService" as Wallet
participant "LedgerService" as Ledger

== Phase 1: Registration (Synchronous) ==

Frontend -> Controller: POST /v1/payments
activate Controller

note left of Frontend
    **Request Payload:**
    {
      "checkoutId": "checkout-123",
      "buyerId": "buyer-456",
      "paymentOrders": [
        {
          "paymentOrderId": "uuid-001",
          "sellerId": "seller-001",
          "amount": "700.00",
          "currency": "INR"
        }
      ]
    }
end note

Controller -> Service: processPayment(request)
activate Service

Service -> Service: createPayment(request)
activate Service
Service -> PaymentRepo: save(payment)
activate PaymentRepo
PaymentRepo --> Service: Payment saved
deactivate PaymentRepo
deactivate Service

loop For each PaymentOrder
    Service -> Service: processPaymentOrder(payment, orderReq)
    activate Service
    
    Service -> OrderRepo: findById(paymentOrderId) (Idempotency Check)
    activate OrderRepo
    OrderRepo --> Service: Optional<PaymentOrder>
    deactivate OrderRepo
    
    alt New Order
        Service -> OrderRepo: save(paymentOrder) (Status: NOT_STARTED)
        activate OrderRepo
        OrderRepo --> Service: Saved
        deactivate OrderRepo
        
        Service -> Executor: createCheckoutSession(paymentOrder)
        activate Executor
        
        Executor -> PSP: createCheckoutSession(orderId, amount, currency)
        activate PSP
        PSP --> Executor: CheckoutSession(sessionId, checkoutUrl)
        deactivate PSP
        
        Executor --> Service: CheckoutSession
        deactivate Executor
        
        Service -> OrderRepo: Update status to PENDING_USER_ACTION
        activate OrderRepo
        OrderRepo --> Service: Updated
        deactivate OrderRepo
        
    end
    
    Service --> Service: PaymentOrderResponse (with checkoutUrl)
    deactivate Service
end

Service --> Controller: PaymentResponse (with checkoutUrl)
deactivate Service

Controller --> Frontend: 200 OK + checkoutUrl
deactivate Controller

Frontend -> Frontend: Redirect user to checkoutUrl

== Phase 2: Confirmation (Asynchronous Webhook) ==

... User completes payment on PSP Page ...

PSP -> Webhook: POST /webhooks/razorpay (or stripe)
activate Webhook

note right of PSP
    **Webhook Payload:**
    {
      "event": "payment.captured",
      "payload": {
        "payment": { "id": "pay_123", "status": "captured" },
        "order": { "receipt": "uuid-001" }
      }
    }
end note

Webhook -> OrderRepo: findById("uuid-001")
activate OrderRepo
OrderRepo --> Webhook: PaymentOrder
deactivate OrderRepo

alt Order Found & Not Success
    Webhook -> OrderRepo: Update status to SUCCESS
    activate OrderRepo
    OrderRepo --> Webhook: Updated
    deactivate OrderRepo
    
    Webhook -> Wallet: credit(sellerId, amount)
    activate Wallet
    Wallet --> Webhook: Credited
    deactivate Wallet
    
    Webhook -> Ledger: createDoubleEntry(buyer, seller, amount)
    activate Ledger
    Ledger --> Webhook: Recorded
    deactivate Ledger
    
    Webhook -> OrderRepo: Save final state
    activate OrderRepo
    OrderRepo --> Webhook: Saved
    deactivate OrderRepo
end

Webhook --> PSP: 200 OK
deactivate Webhook

@enduml
