@startuml payment-double-entry-ledger
!theme plain

title Payment System - Double-Entry Ledger Verification

participant "Payment\nService" as PaymentSvc
participant "Ledger\nService" as LedgerSvc
participant "Ledger\nRepository" as LedgerRepo
database "Database" as DB

PaymentSvc -> LedgerSvc: recordTransaction(order)
activate LedgerSvc

note over LedgerSvc
    order: {
        buyerId: "buyer123",
        sellerId: "seller456",
        amount: 100.00
    }
end note

LedgerSvc -> LedgerSvc: transactionId = UUID.random()

== Debit Buyer ==
LedgerSvc -> DB: Save LedgerEntry
note right of DB
    {
        txnId: "txn-001",
        accountId: "buyer123",
        type: DEBIT,
        amount: 100.00
    }
end note

== Credit Seller ==
LedgerSvc -> DB: Save LedgerEntry
note right of DB
    {
        txnId: "txn-001",
        accountId: "seller456",
        type: CREDIT,
        amount: 100.00
    }
end note

== Verify Double-Entry ==
LedgerSvc -> LedgerRepo: verifyDoubleEntry(txnId)
activate LedgerRepo

note over LedgerRepo
    SELECT SUM(CASE
        WHEN type='DEBIT' THEN -amount
        ELSE amount
    END)
    FROM ledger_entry
    WHERE transaction_id = 'txn-001'
end note

LedgerRepo -> DB: Execute query
DB --> LedgerRepo: sum = 0

alt Sum = 0
    LedgerRepo --> LedgerSvc: ✓ Verified
    note right #lightgreen
        DEBIT (-100) + CREDIT (+100) = 0
        Double-entry is balanced!
    end note
    LedgerSvc --> PaymentSvc: Success
else Sum ≠ 0
    LedgerRepo --> LedgerSvc: ✗ Failed
    note right #lightcoral
        Ledger is unbalanced!
        Critical error!
    end note
    LedgerSvc -> LedgerSvc: throw LedgerException
end

deactivate LedgerRepo
deactivate LedgerSvc

@enduml
