@startuml Pricing Service Flow

title Pricing Service - Multi-Currency Price Calculation Flow

actor Customer
participant "Product\nService" as Product
participant "Pricing\nService" as Pricing
participant "Region\nService" as Region
participant "Currency\nService" as Currency
participant "Tax\nService" as Tax
database "Price DB" as DB
database "Exchange Rate\nCache" as Cache

== Step 1: Customer Views Product ==

Customer -> Product: View Product
activate Product

Product -> Pricing: Get Price (productId, variantId, region, currency)
activate Pricing

Pricing -> DB: Get Base Price (USD)
activate DB
DB --> Pricing: Base Price = $100.00
deactivate DB

== Step 2: Check Regional Override ==

Pricing -> DB: Get Regional Price (productId, region)
activate DB

alt Regional Price Exists
    DB --> Pricing: Regional Price (EUR €85.00)
    note right: Seller set specific price\nfor European market
else No Regional Override
    DB --> Pricing: No override
    note right: Use base price\nwith conversion
end
deactivate DB

== Step 3: Currency Conversion ==

alt Need Currency Conversion
    Pricing -> Currency: Convert (USD → INR)
    activate Currency
    
    Currency -> Cache: Get Exchange Rate
    activate Cache
    
    alt Rate in Cache
        Cache --> Currency: Rate = 83.50
    else Rate Expired/Missing
        Currency -> Currency: Fetch from API
        Currency -> Cache: Update Cache
        Cache --> Currency: Rate = 83.50
    end
    deactivate Cache
    
    Currency --> Pricing: Converted Price = ₹8,350.00
    deactivate Currency
end

== Step 4: Apply Price Rules ==

Pricing -> DB: Get Active Price Rules
activate DB
DB --> Pricing: Rules List
deactivate DB

loop For each rule
    Pricing -> Pricing: Evaluate Rule
    note right: Rules:\n- Bulk discount (10+ qty)\n- Seasonal sale (20% off)\n- Customer segment (VIP 5% off)
    
    alt Rule Applies
        Pricing -> Pricing: Apply Adjustment
        note right: Apply discount/markup
    end
end

Pricing -> Pricing: Calculate Subtotal
note right: After all rules:\n₹7,500.00 (10% bulk discount)

== Step 5: Calculate Tax ==

Pricing -> Region: Get Region Tax Rules
activate Region
Region --> Pricing: Tax Rules (GST 18%)
deactivate Region

Pricing -> Tax: Calculate Tax (₹7,500, 18%)
activate Tax
Tax --> Pricing: Tax = ₹1,350.00
deactivate Tax

== Step 6: Build Price Result ==

Pricing -> Pricing: Build PriceCalculationResult
note right: Result includes:\n- Base price: $100.00\n- Converted: ₹8,350.00\n- Discount: ₹850.00\n- Subtotal: ₹7,500.00\n- Tax: ₹1,350.00\n- Total: ₹8,850.00

Pricing --> Product: PriceCalculationResult
deactivate Pricing

Product --> Customer: Display Price (₹8,850.00)
deactivate Product

== Price Display to Customer ==

note over Customer
**Price Breakdown**
--
Base Price: ₹8,350.00
Bulk Discount (10%): -₹850.00
--
Subtotal: ₹7,500.00
GST (18%): ₹1,350.00
--
**Total: ₹8,850.00**

You Save: ₹850.00 (10%)
end note

@enduml
