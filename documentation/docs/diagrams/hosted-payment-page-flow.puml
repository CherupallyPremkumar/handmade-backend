@startuml hosted-payment-page-flow
!theme plain
skinparam sequenceMessageAlign center

title Complete Checkout to Payment Flow (Hosted Payment Page)

actor User
participant "Frontend" as Frontend
participant "Payment\nService" as PaymentSvc
participant "PSP\n(Razorpay)" as PSP
participant "PSP Hosted\nPayment Page" as HostedPage
database "Database" as DB

== Step 1: User Reviews Order ==
User -> Frontend: Click "Place Order"
activate Frontend

note over Frontend
    Order Summary:
    - Total: ₹1000
    - Seller 1: ₹700
    - Seller 2: ₹300
end note

== Step 2: Register Payment with PSP ==
Frontend -> PaymentSvc: POST /v1/payments/register
activate PaymentSvc

note left of PaymentSvc
    **Request:**
    {
      "checkoutId": "checkout-123",
      "buyerId": "buyer-456",
      "amount": "1000.00",
      "currency": "INR",
      "redirectUrl": "https://yoursite.com/payment-success"
    }
    
    ❌ NO payment method selected yet!
    ❌ NO card details!
end note

PaymentSvc -> DB: Save PaymentEvent\n(status=PENDING)

PaymentSvc -> PSP: Register payment
activate PSP

note right of PSP
    **PSP Registration:**
    {
      "amount": "1000.00",
      "currency": "INR",
      "nonce": "payment-order-uuid-001"
    }
end note

PSP --> PaymentSvc: Return token
note right of PSP
    {
      "token": "razorpay_token_xyz123"
    }
end note
deactivate PSP

PaymentSvc -> DB: Save token

PaymentSvc --> Frontend: Payment registered
deactivate PaymentSvc

note right of Frontend
    **Response:**
    {
      "paymentToken": "razorpay_token_xyz123",
      "hostedPageUrl": "https://razorpay.com/checkout"
    }
end note

== Step 3: Redirect to PSP Hosted Page ==
Frontend -> HostedPage: Redirect with token
activate HostedPage

note over HostedPage #lightblue
    **PSP Hosted Payment Page**
    (Razorpay/Stripe page)
    
    User sees:
    - Payment methods (Card, UPI, Wallet)
    - Amount: ₹1000
end note

User -> HostedPage: Select payment method\n(e.g., Credit Card)

note over User,HostedPage
    ✅ User selects payment method HERE
    ✅ On PSP's page, NOT your website!
end note

User -> HostedPage: Enter card details\n(Card number, CVV, etc.)

note over HostedPage #yellow
    ✅ Card details go to PSP
    ❌ Your backend NEVER sees card details!
    (PCI DSS compliance)
end note

HostedPage -> PSP: Process payment
activate PSP

PSP -> PSP: Charge card

PSP --> HostedPage: Payment success
deactivate PSP

== Step 4: Redirect Back to Your Website ==
HostedPage -> Frontend: Redirect to redirectUrl\n+ payment status
deactivate HostedPage

note right of Frontend
    Redirect URL:
    https://yoursite.com/payment-success
      ?token=razorpay_token_xyz123
      &status=success
end note

Frontend --> User: Show "Payment Successful!"
deactivate Frontend

== Step 5: PSP Webhook (Async) ==
PSP -> PaymentSvc: Webhook notification
activate PaymentSvc

note left of PaymentSvc
    **Webhook Payload:**
    {
      "token": "razorpay_token_xyz123",
      "status": "success",
      "paymentId": "razorpay_pay_abc123"
    }
end note

PaymentSvc -> DB: Update PaymentEvent\n(status=SUCCESS)
PaymentSvc -> DB: Update PaymentOrder\n(status=SUCCESS, pspToken)

note over PaymentSvc #lightgreen
    Now trigger:
    - Wallet update
    - Ledger update
end note

PaymentSvc --> PSP: 200 OK
deactivate PaymentSvc

note over User,DB
    **Key Points:**
    1. User selects payment method on PSP page
    2. Your backend never sees card details
    3. PSP handles all payment methods
    4. Webhook updates your system asynchronously
end note

@enduml
