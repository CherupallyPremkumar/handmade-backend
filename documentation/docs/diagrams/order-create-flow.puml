@startuml order-create-flow
!theme plain
skinparam sequenceMessageAlign center

title Order Creation Flow - Complete Request/Response Details

actor User
participant "Frontend" as Frontend
participant "Order\nController" as OrderCtrl
participant "Order\nService" as OrderSvc
database "Database" as DB

== User Initiates Checkout ==
User -> Frontend: Click "Checkout"
activate Frontend

note over Frontend
    Cart contains:
    - Product A (Seller 1): ₹500
    - Product B (Seller 2): ₹300
    - Product C (Seller 1): ₹200
end note

== Create Order Request ==
Frontend -> OrderCtrl: POST /api/orders/create
activate OrderCtrl

note left of OrderCtrl
    **Request Payload:**
    {
      "cartId": "cart-abc123",
      "userId": "buyer-456",
      "items": [
        {
          "productId": "prod-001",
          "productName": "Pottery Vase",
          "sellerId": "seller-001",
          "sellerName": "Artisan Crafts",
          "quantity": 1,
          "price": "500.00"
        },
        {
          "productId": "prod-002",
          "productName": "Cutting Board",
          "sellerId": "seller-002",
          "sellerName": "Wood Works",
          "quantity": 1,
          "price": "300.00"
        },
        {
          "productId": "prod-003",
          "productName": "Ceramic Bowl",
          "sellerId": "seller-001",
          "sellerName": "Artisan Crafts",
          "quantity": 1,
          "price": "200.00"
        }
      ]
    }
end note

OrderCtrl -> OrderSvc: createOrder(request)
activate OrderSvc

== Step 1: Generate Checkout ID ==
OrderSvc -> OrderSvc: checkoutId = UUID.random()

note over OrderSvc #lightblue
    Generated: "checkout-abc123"
end note

== Step 2: Group Items by Seller ==
OrderSvc -> OrderSvc: Group items by sellerId

note over OrderSvc #lightyellow
    Seller 1 (seller-001):
    - Product A: ₹500
    - Product C: ₹200
    Total: ₹700
    
    Seller 2 (seller-002):
    - Product B: ₹300
    Total: ₹300
end note

== Step 3: Create Order Entity ==
OrderSvc -> DB: Save Order
note right of DB
    Order {
      id: "order-789",
      checkoutId: "checkout-abc123",
      cartId: "cart-abc123",
      buyerId: "buyer-456",
      totalAmount: 1000.00,
      status: "PENDING_PAYMENT"
    }
end note

DB --> OrderSvc: Order saved

== Step 4: Create Order Line Items ==
OrderSvc -> DB: Save OrderLineItems

note right of DB
    OrderLineItem 1 {
      id: "line-001",
      orderId: "order-789",
      sellerId: "seller-001",
      sellerName: "Artisan Crafts",
      subtotal: 700.00,
      itemCount: 2
    }
    
    OrderLineItem 2 {
      id: "line-002",
      orderId: "order-789",
      sellerId: "seller-002",
      sellerName: "Wood Works",
      subtotal: 300.00,
      itemCount: 1
    }
end note

DB --> OrderSvc: Line items saved

== Step 5: Build Response ==
OrderSvc -> OrderSvc: Build sellerTotals array

note over OrderSvc #lightgreen
    sellerTotals = [
      {
        sellerId: "seller-001",
        sellerName: "Artisan Crafts",
        amount: "700.00",
        currency: "INR",
        itemCount: 2,
        items: [prod-001, prod-003]
      },
      {
        sellerId: "seller-002",
        sellerName: "Wood Works",
        amount: "300.00",
        currency: "INR",
        itemCount: 1,
        items: [prod-002]
      }
    ]
end note

OrderSvc --> OrderCtrl: OrderResponse
deactivate OrderSvc

OrderCtrl --> Frontend: 200 OK
deactivate OrderCtrl

note right of Frontend
    **Response Payload:**
    {
      "orderId": "order-789",
      "checkoutId": "checkout-abc123",
      "sellerTotals": [
        {
          "sellerId": "seller-001",
          "sellerName": "Artisan Crafts",
          "amount": "700.00",
          "currency": "INR",
          "itemCount": 2,
          "items": [
            {
              "productId": "prod-001",
              "productName": "Pottery Vase",
              "quantity": 1,
              "price": "500.00"
            },
            {
              "productId": "prod-003",
              "productName": "Ceramic Bowl",
              "quantity": 1,
              "price": "200.00"
            }
          ]
        },
        {
          "sellerId": "seller-002",
          "sellerName": "Wood Works",
          "amount": "300.00",
          "currency": "INR",
          "itemCount": 1,
          "items": [
            {
              "productId": "prod-002",
              "productName": "Cutting Board",
              "quantity": 1,
              "price": "300.00"
            }
          ]
        }
      ],
      "grandTotal": "1000.00",
      "currency": "INR"
    }
end note

== Step 6: Frontend Prepares Payment ==
Frontend -> Frontend: Generate payment order IDs

note over Frontend #lightblue
    For each seller in sellerTotals:
    - Generate UUID (idempotency key)
    
    paymentOrders = [
      {
        paymentOrderId: uuidv4(),  // "uuid-001"
        sellerId: "seller-001",
        amount: "700.00",
        currency: "INR"
      },
      {
        paymentOrderId: uuidv4(),  // "uuid-002"
        sellerId: "seller-002",
        amount: "300.00",
        currency: "INR"
      }
    ]
end note

Frontend --> User: Show order summary
deactivate Frontend

note over User,DB
    **Key Points:**
    1. Order Service groups cart items by seller
    2. Returns sellerTotals (NOT payment orders)
    3. Frontend generates paymentOrderIds (UUIDs)
    4. Frontend then calls /v1/payments with these IDs
end note

@enduml
