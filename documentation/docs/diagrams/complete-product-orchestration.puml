@startuml Complete Product Orchestration Sequence

title Complete Product Orchestration - From Creation to Live

skinparam backgroundColor #FEFEFE
skinparam sequenceMessageAlign center

actor Seller
participant "Product\nOrchestration" as Orch
box "Domain Services" #LightBlue
    participant "Product\nService" as Product
    participant "Category\nService" as Category
    participant "Pricing\nService" as Pricing
    participant "Inventory\nService" as Inventory
    participant "Catalog\nService" as Catalog
end box
participant "Review\nService" as Review
participant "Notification\nService" as Notify
database "Database" as DB

== Phase 1: Product Creation (DRAFT) ==

Seller -> Orch: Create Product Request
activate Orch

Orch -> Orch: ValidateSellerCommand
note right: Check seller status\nCheck product limits

Orch -> Category: Get Category Details
activate Category
Category -> DB: Fetch Category
DB --> Category: Category + InventoryStrategy
Category --> Orch: Category (Electronics, VARIANT_BASED)
deactivate Category

Orch -> Orch: ValidateProductDataCommand
note right: Validate required fields\nCheck SKU uniqueness\nValidate images

Orch -> Product: createProduct(DRAFT)
activate Product
Product -> DB: INSERT Product
note right: Status: DRAFT\nState: DRAFT
DB --> Product: Product Created
Product --> Orch: Product Entity
deactivate Product

Orch -> Pricing: createBasePrice(productId, USD, $100)
activate Pricing
Pricing -> DB: INSERT Price
note right: Base currency: USD\nBase price: $100\nType: STANDARD
DB --> Pricing: Price Created
Pricing --> Orch: Price Entity
deactivate Pricing

Orch -> Notify: sendNotification("Draft Saved")
activate Notify
Notify --> Seller: Email + Dashboard Notification
deactivate Notify

Orch --> Seller: Product ID + DRAFT Status
deactivate Orch

== Phase 2: Add Variants & Inventory ==

Seller -> Orch: Add Variants Request
activate Orch

Orch -> Orch: CreateVariantsCommand
note right: Validate variant data\nGenerate variant SKUs\nCheck category allows variants

loop For each variant
    Orch -> Product: addVariant(variant)
    activate Product
    Product -> Product: validateCanAddVariant()
    note right: Check product status\nCheck category rules
    Product -> DB: INSERT ProductVariant
    note right: Status: DRAFT\nState: DRAFT\nProduct state: UNCHANGED
    DB --> Product: Variant Created
    Product --> Orch: Variant Entity
    deactivate Product
    
    Orch -> Pricing: createVariantPrice(variantId, $95)
    activate Pricing
    Pricing -> DB: INSERT Price (for variant)
    DB --> Pricing: Variant Price Created
    Pricing --> Orch: Price Entity
    deactivate Pricing
end

Orch -> Orch: CreateInventoryCommand
note right: Based on category strategy:\nVARIANT_BASED for Electronics

loop For each variant
    Orch -> Inventory: createVariantInventory(variantId, qty)
    activate Inventory
    Inventory -> DB: INSERT VariantInventory
    note right: Type: VARIANT_BASED\nQuantity: 100\nReorder Point: 20
    DB --> Inventory: Inventory Created
    Inventory --> Orch: Inventory Entity
    deactivate Inventory
end

Orch --> Seller: Variants & Inventory Added
deactivate Orch

== Phase 3: Regional Pricing (Optional) ==

Seller -> Orch: Set Regional Prices
activate Orch

Orch -> Pricing: createRegionalPrice(priceId, "EU", "EUR", €85)
activate Pricing
Pricing -> DB: INSERT RegionalPrice
note right: Region: EU\nCurrency: EUR\nPrice: €85\nTax: 20% VAT
DB --> Pricing: Regional Price Created
Pricing --> Orch: RegionalPrice Entity
deactivate Pricing

Orch -> Pricing: createRegionalPrice(priceId, "IN", "INR", ₹8350)
activate Pricing
Pricing -> DB: INSERT RegionalPrice
note right: Region: IN\nCurrency: INR\nPrice: ₹8350\nTax: 18% GST
DB --> Pricing: Regional Price Created
Pricing --> Orch: RegionalPrice Entity
deactivate Pricing

Orch --> Seller: Regional Prices Set
deactivate Orch

== Phase 4: Add Price Rules (Optional) ==

Seller -> Orch: Add Bulk Discount Rule
activate Orch

Orch -> Pricing: createPriceRule(priceId, BULK_DISCOUNT)
activate Pricing
Pricing -> DB: INSERT PriceRule
note right: Type: BULK_DISCOUNT\nCondition: qty >= 10\nAdjustment: 10% OFF\nPriority: 1
DB --> Pricing: Price Rule Created
Pricing --> Orch: PriceRule Entity
deactivate Pricing

Orch --> Seller: Price Rule Added
deactivate Orch

== Phase 5: Compliance & Categorization ==

Seller -> Orch: Set Category & Compliance
activate Orch

Orch -> Orch: ValidateComplianceCommand
note right: Check category requirements\nValidate tax codes\nCheck restricted items

Orch -> Catalog: createCatalogEntry(productId, categoryId)
activate Catalog
Catalog -> Catalog: generateSearchKeywords()
note right: Extract keywords from:\n- Product name\n- Description\n- Category\n- Tags
Catalog -> DB: INSERT CatalogEntry
note right: Search keywords indexed\nPopularity: 0\nView count: 0
DB --> Catalog: Catalog Entry Created
Catalog --> Orch: CatalogEntry Entity
deactivate Catalog

Orch --> Seller: Compliance Validated
deactivate Orch

== Phase 6: Submit for Review ==

Seller -> Orch: Submit for Review
activate Orch

Orch -> Orch: SubmitForReviewCommand
note right: Validate all required data\nCheck all variants valid\nCheck inventory exists

Orch -> Product: updateStatus(PENDING_REVIEW)
activate Product
Product -> Product: Product State Machine
note right: State Transition:\nDRAFT → PENDING_REVIEW
Product -> DB: UPDATE Product
DB --> Product: Status Updated
Product --> Orch: Product Updated
deactivate Product

Orch -> Review: createReviewTask(productId)
activate Review
Review -> DB: INSERT ReviewTask
note right: Task Type: PRODUCT_REVIEW\nStatus: PENDING\nAssigned: Review Team
DB --> Review: Review Task Created
Review --> Orch: ReviewTask Entity
deactivate Review

Orch -> Notify: sendNotification("Submitted for Review")
activate Notify
Notify --> Seller: Email + Dashboard Notification
deactivate Notify

Orch --> Seller: PENDING_REVIEW Status
deactivate Orch

== Phase 7: Admin Review ==

actor Admin
Admin -> Review: Review Product
activate Review

Review -> Product: getProduct(productId)
activate Product
Product -> DB: SELECT Product + Variants + Images
DB --> Product: Product Data
Product --> Review: Product Entity
deactivate Product

Review -> Review: Content Moderation
note right: Check prohibited items\nImage quality check\nPrice validation\nDuplicate detection

alt Product Approved
    Review -> Product: approve(productId)
    activate Product
    Product -> Product: Product State Machine
    note right: State Transition:\nPENDING_REVIEW → APPROVED
    Product -> DB: UPDATE Product
    DB --> Product: Status Updated
    Product --> Review: Product Approved
    deactivate Product
    
    Review -> Notify: sendNotification("Product Approved")
    activate Notify
    Notify --> Seller: Email + Dashboard Notification
    deactivate Notify
    
else Needs Revision
    Review -> Product: requestRevision(productId, feedback)
    activate Product
    Product -> Product: Product State Machine
    note right: State Transition:\nPENDING_REVIEW → NEEDS_REVISION
    Product -> DB: UPDATE Product
    DB --> Product: Status Updated
    Product --> Review: Revision Requested
    deactivate Product
    
    Review -> Notify: sendNotification("Needs Revision", feedback)
    activate Notify
    Notify --> Seller: Email + Dashboard + SMS
    deactivate Notify
    
else Product Rejected
    Review -> Product: reject(productId, reason)
    activate Product
    Product -> Product: Product State Machine
    note right: State Transition:\nPENDING_REVIEW → REJECTED
    Product -> DB: UPDATE Product
    DB --> Product: Status Updated
    Product --> Review: Product Rejected
    deactivate Product
    
    Review -> Notify: sendNotification("Product Rejected", reason)
    activate Notify
    Notify --> Seller: Email + Dashboard + SMS
    deactivate Notify
end

Review --> Admin: Review Complete
deactivate Review

== Phase 8: Publish Product (If Approved) ==

alt If Approved
    Review -> Orch: publishProduct(productId)
    activate Orch
    
    Orch -> Orch: PublishProductCommand
    note right: Validate all variants approved\nCheck inventory available\nValidate pricing complete
    
    Orch -> Product: publish(productId)
    activate Product
    Product -> Product: Product State Machine
    note right: State Transition:\nAPPROVED → ACTIVE
    Product -> DB: UPDATE Product
    DB --> Product: Status Updated
    
    ' Activate all approved variants
    Product -> Product: activateApprovedVariants()
    note right: Variant State Machines:\nAPPROVED → ACTIVE
    Product -> DB: UPDATE ProductVariants
    DB --> Product: Variants Activated
    Product --> Orch: Product Published
    deactivate Product
    
    Orch -> Catalog: indexInSearch(productId)
    activate Catalog
    Catalog -> Catalog: buildSearchIndex()
    note right: Index:\n- Product name\n- Description\n- Category\n- Price range\n- Attributes
    Catalog -> DB: UPDATE CatalogEntry
    note right: Indexed: true\nSearchable: true
    DB --> Catalog: Indexed
    Catalog --> Orch: Search Indexed
    deactivate Catalog
    
    Orch -> Inventory: makeAvailable(productId)
    activate Inventory
    Inventory -> DB: UPDATE Inventory
    note right: Mark inventory as available\nfor purchase
    DB --> Inventory: Inventory Available
    Inventory --> Orch: Inventory Ready
    deactivate Inventory
    
    Orch -> Notify: sendNotification("Product Live!")
    activate Notify
    Notify --> Seller: Email + Dashboard + SMS
    deactivate Notify
    
    Orch --> Seller: Product ACTIVE & LIVE
    deactivate Orch
end

== Phase 9: Customer Views Product ==

actor Customer
Customer -> Catalog: Browse Category / Search
activate Catalog

Catalog -> DB: Search Products
note right: Full-text search\nFaceted filtering\nPrice range\nRating filter
DB --> Catalog: Product List

Catalog -> Product: getProductDetails(productId)
activate Product
Product -> DB: SELECT Product + Variants + Images
DB --> Product: Product Data
Product --> Catalog: Product Entity
deactivate Product

Catalog -> Pricing: calculatePrice(productId, region, currency)
activate Pricing

Pricing -> DB: Get Base Price
DB --> Pricing: Price (USD $100)

Pricing -> DB: Get Regional Price Override
DB --> Pricing: RegionalPrice (INR ₹8350)

Pricing -> DB: Get Exchange Rate (if needed)
DB --> Pricing: ExchangeRate

Pricing -> DB: Get Active Price Rules
DB --> Pricing: PriceRules (Bulk Discount)

Pricing -> Pricing: applyPriceRules()
note right: Calculate final price\nwith all rules applied

Pricing -> DB: Get Tax Rules for Region
DB --> Pricing: TaxRule (GST 18%)

Pricing -> Pricing: calculateTax()
note right: Final Price:\nBase: ₹8350\nDiscount: ₹0\nTax: ₹1503\nTotal: ₹9853

Pricing --> Catalog: PriceCalculationResult
deactivate Pricing

Catalog -> Inventory: checkAvailability(variantId)
activate Inventory
Inventory -> DB: SELECT VariantInventory
DB --> Inventory: Inventory (Qty: 100)
Inventory --> Catalog: Available (100 units)
deactivate Inventory

Catalog --> Customer: Product Details + Price + Availability
deactivate Catalog

note over Customer
**Product Display**
--
Name: Smartphone XYZ
Price: ₹9,853 (incl. GST)
Rating: 4.5 ⭐ (120 reviews)
Availability: In Stock (100 units)
Variants: 3 colors, 2 storage options
Shipping: Free delivery
end note

@enduml
